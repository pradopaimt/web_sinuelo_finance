<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/favicon.ico" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <title>Financeiro - Agropecuária Sinuelo</title>

<script>
  if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
    window.API_BASE = 'http://127.0.0.1:8000/api';
  } else {
    window.API_BASE = location.origin + '/api';
  }
</script>

  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#06b6d4; --danger:#ef4444; --shadow:0 10px 25px rgba(0,0,0,.35); --radius:16px }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Noto Sans,Arial; color:var(--text); background:linear-gradient(180deg,#0b1220 0%,#0f172a 100%); min-height:100svh}
    header{position:sticky; top:0; z-index:10; background:rgba(15,23,42,.8); backdrop-filter:saturate(1.2) blur(10px); border-bottom:1px solid rgba(255,255,255,.06)}
    .container{max-width:1100px; margin:0 auto; padding:16px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:36px; height:36px; border-radius:12px; background:radial-gradient(circle at 30% 30%, var(--accent) 0%, #16a34a 35%, #164e63 100%); box-shadow:var(--shadow)}
    h1{font-size:20px; margin:0; letter-spacing:.3px}
    nav{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; align-items:center}
    .tab{border:1px solid rgba(255,255,255,.08); background:#0b1220; color:var(--text); padding:10px 14px; border-radius:999px; cursor:pointer}
    .tab.active{background:var(--accent-2); color:#001015; border-color:transparent; font-weight:600}
    .install{margin-left:auto; display:flex; gap:8px; align-items:center}
    .install button{background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.18)}
    .grid{display:grid; gap:16px; grid-template-columns:1fr}
    @media (min-width: 900px){ .grid{grid-template-columns:1.1fr .9fr} }
    .card{background:rgba(17,24,39,.75); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)}
    .card h2{margin:4px 0 12px 0; font-size:18px}
    label{font-size:12px; color:var(--muted)}
    input, select, textarea{width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0b1220; color:var(--text)}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:700px){.row.cols-2{grid-template-columns:1fr 1fr}}
    @media(min-width:900px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}}
    button{appearance:none; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; background:var(--accent); color:#052e16; font-weight:700; box-shadow:var(--shadow)}
    button.secondary{background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.1)}
    button.danger{background:var(--danger); color:#310808}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    .kpis{display:grid; grid-template-columns: 1fr; gap:12px}
    .kpi{background:#0b1220;border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:20px; font-weight:800; margin-top:4px}
    table{width:100%; border-collapse:collapse}
    th, td{ padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left; font-size:14px}
    th{color:var(--muted); font-weight:600}
    tr:hover{background:rgba(255,255,255,.03)}
    footer{color:var(--muted); font-size:12px; text-align:center; padding:24px}
    @media (display-mode: standalone){ body{background:#0f172a} }
    .small{font-size:12px;color:var(--muted)}
    .inline{display:inline-flex; gap:8px; align-items:center}
    .subtitle{font-size:14px; color:var(--muted); margin-top:-6px}
    .muted{color:var(--muted); font-size:12px}
    #err{display:none; margin-top:8px; background:rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.35); color:#fecaca; padding:10px 12px; border-radius:12px; white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Financeiro - Agropecuária Sinuelo</h1>
          <div style="font-size:12px; color:var(--muted)">v24.08.2025</div>
        </div>
      </div>
      <nav style="margin-top:14px">
        <div class="tab active" data-tab="lancamentos">Lançamentos</div>
        <div class="tab" data-tab="extrato">Extrato</div>
        <div class="tab" data-tab="categorias">Plano de Contas</div>
        <div class="tab" data-tab="demo">Demonstrativos</div>
        <div class="install">
          <button id="btnInstall" style="display:none">Instalar app</button>
          <span id="installHint" style="font-size:12px; color:var(--muted); display:none">Use ⋮ → Adicionar à tela inicial</span>
        </div>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top:18px">
    <!-- Lançamentos -->
<section id="lancamentos" class="grid">
  <div class="card">
    <h2>Novo lançamento</h2>

    <form id="formLanc" autocomplete="off">
      <!-- Linha 1: Data, Valor, Pagamento -->
      <div class="row cols-3">
        <div>
          <label for="data">Data</label>
          <input type="date" id="data" required />
        </div>
        <div>
          <label for="valor">Valor (R$)</label>
          <input inputmode="decimal" id="valor" placeholder="0,00" required />
        </div>
        <div>
          <label for="pagamento">Forma de pagamento</label>
          <select id="pagamento">
            <option>Pix</option>
            <option>Dinheiro</option>
            <option>Cartão</option>
            <option>Boleto</option>
            <option>Transferência</option>
            <option>Nota a pagar/receber</option>
          </select>
        </div>
      </div>

      <!-- Linha 2: Descrição, Fornecedor_Cliente -->
      <div class="row cols-2" style="margin-top:12px">
        <div>
          <label for="descricao">Descrição</label>
          <input id="descricao" placeholder="Ex.: Venda bezerros, ração, adubo..." />
        </div>
        <div>
          <label for="fornecedor_cliente">Fornecedor_Cliente</label>
          <input id="fornecedor_cliente" placeholder="Digite o nome do fornecedor ou cliente" />
        </div>
      </div>

      <!-- Linha 3: Natureza, Conta, Categoria -->
      <div class="row cols-3" style="margin-top:12px">
        <div>
          <label for="natureza">Natureza</label>
          <select id="natureza" required></select>
        </div>
        <div>
          <label for="conta">Conta</label>
          <select id="conta"></select>
        </div>
        <div>
          <label for="categoria">Categoria</label>
          <select id="categoria"></select>
        </div>
      </div>

      <!-- Linha 4: Centro, Anexo -->
      <div class="row cols-2" style="margin-top:12px">
        <div>
          <label for="centro">Centro de Custo</label>
          <select id="centro"></select>
        </div>
        <div>
          <label for="anexo">Anexo (foto ou PDF da nota)</label>
          <input type="file" id="anexo" accept="image/*,.pdf" />
        </div>
      </div>

      <!-- Linha 5: IR -->
      <div class="row" style="margin-top:8px">
        <label class="inline">
          <input type="checkbox" id="impostoRenda" style="width:auto;margin-right:8px" />
          Marcar como "Imposto de Renda"
        </label>
      </div>

      <!-- Ações -->
      <div class="btns" style="margin-top:16px">
        <button type="submit">Salvar lançamento</button>
        <button type="button" class="secondary" id="limpar">Limpar</button>
      </div>
    </form>
  </div>

  <!-- Painel de KPIs (sem alterações) -->
  <div class="card">
    <h2>Resumo rápido (mês)</h2>
    <div class="kpis">
      <div class="kpi"><div class="label">Receita Operacional</div><div class="value" id="kpiRO">R$ 0,00</div></div>
      <div class="kpi"><div class="label">Receita Não Operac.</div><div class="value" id="kpiRNO">R$ 0,00</div></div>
      <div class="kpi"><div class="label">Despesa Operacional</div><div class="value" id="kpiDO">R$ 0,00</div></div>
      <div class="kpi"><div class="label">Despesa Não Operac.</div><div class="value" id="kpiDNO">R$ 0,00</div></div>
    </div>
    <div style="margin-top:8px; font-size:13px; color:var(--muted)">Saldo: <b id="kpiSaldo">R$ 0,00</b></div>
    <div style="margin-top:16px" class="btns">
      <button type="button" class="secondary" id="exportCsv">Exportar CSV</button>
      <button type="button" class="secondary" id="importCsvBtn">Importar CSV</button>
      <input type="file" id="importCsv" accept="text/csv" style="display:none" />
    </div>
  </div>
</section>

    <!-- Extrato -->
    <section id="extrato" class="card" style="display:none">
      <div class="row cols-3">
        <div>
          <label for="filtroMes">Mês</label>
          <input type="month" id="filtroMes" />
        </div>
        <div>
          <label for="filtroNatureza">Natureza</label>
          <select id="filtroNatureza"><option value="">Todas</option></select>
        </div>
        <div>
          <label for="buscaTxt">Busca</label>
          <input id="buscaTxt" placeholder="Descrição, categoria, conta, centro..." />
        </div>
      </div>
      <div style="overflow:auto; margin-top:12px">
        <table id="tabela">
          <thead>
            <tr>
              <th>Data</th>
              <th>Natureza</th>
			  <th>Conta</th>
              <th>Categoria</th>
              <th>Centro</th>
			  <th>Fornecedor_Cliente</th>
			  <th>Descrição</th>
              <th>Valor</th>
              <th>Pagamento</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Plano de Contas + Centros -->
    <section id="categorias" class="card" style="display:none">
      <h2>Plano de Contas (Natureza → Conta → Categoria)</h2>
      <div class="subtitle">Gerencie também os <b>Centros de Custo</b> abaixo.</div>

      <div id="pcTree" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin-top:12px"></div>

      <div class="row cols-3" style="margin-top:12px">
        <div>
          <label>Natureza</label>
          <select id="pcNat"></select>
        </div>
        <div>
          <label>Conta</label>
          <select id="pcConta"></select>
        </div>
        <div class="btns" style="align-items:end">
          <input id="pcNovaCat" placeholder="Nova categoria" />
          <button id="pcAddCat">Adicionar categoria</button>
        </div>
      </div>

      <div class="row cols-3" style="margin-top:8px">
        <div class="btns" style="align-items:end">
          <input id="pcNovaConta" placeholder="Nova conta" />
          <button id="pcAddConta">Adicionar conta</button>
        </div>
        <div class="btns" style="align-items:end">
          <input id="pcRenomearConta" placeholder="Novo nome da conta selecionada" />
          <button id="pcBtnRenomear">Renomear conta</button>
        </div>
        <div class="btns" style="align-items:end">
          <button class="danger" id="pcBtnExcluir">Excluir conta selecionada</button>
        </div>
      </div>
      <div class="small" style="margin-top:6px">Ao excluir uma conta com lançamentos, os lançamentos serão <b>reclassificados</b> para outra conta da mesma Natureza (você poderá escolher).</div>

      <hr style="border:none; border-top:1px solid rgba(255,255,255,.08); margin:18px 0">

      <h3 style="margin:0 0 8px 0; font-size:16px">Centros de Custo</h3>
      <div class="row cols-3">
        <div>
          <label>Novo centro</label>
        <input id="novoCentro" placeholder="Ex.: Soja, Bovinos, Ovinos..." />
        </div>
        <div class="btns" style="align-items:end">
          <button id="addCentro">Adicionar</button>
        </div>
      </div>
      <div style="overflow:auto; margin-top:12px">
        <table id="tabCentros">
          <thead><tr><th>Centro</th><th style="width:120px"></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Demonstrativos (APENAS ÁRVORE) -->
    <section id="demo" class="card" style="display:none">
      <h2 style="margin-top:0">Demonstrativo Anual/Safra</h2>
      <div class="small" style="margin: -4px 0 8px 0">Resultado = (Receitas − Despesas). % de cada linha é relativa ao total da Natureza.</div>
      <div id="demonstrativo_tree"></div>
      <div id="err"></div>
      </section>
  </main>

  <footer>© <span id="ano"></span> Agropecuária Sinuelo • Protótipo</footer>

  <!-- Widget do demonstrativo -->
  <script src="demonstrativo_tree.js" defer></script>
	<script>  const API_BASE = window.API_BASE; </script>
  <script>
    // ===== PWA =====
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(console.warn)); }
    let deferredPrompt; const btnInstall=document.getElementById('btnInstall'); const installHint=document.getElementById('installHint');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; btnInstall.style.display='inline-flex'; installHint.style.display='none'; });
    btnInstall?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; btnInstall.style.display='none'; });
    window.addEventListener('appinstalled', ()=> btnInstall.style.display='none'); setTimeout(()=>{ if(btnInstall && btnInstall.style.display==='none'){ installHint.style.display='inline'; } }, 2500);

    // ===== Utils =====
    const BRL = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const parseBR = (s)=> Number(String(s).replace(/\./g,'').replace(',','.')) || 0;
    const fmtDate = (iso)=> new Date(iso + 'T00:00:00').toLocaleDateString('pt-BR');

    // ===== Estado =====
    const state = { lanc: [], centros: [], tax: [] };

    // ===== API =====
    async function fetchJSON(url){
      const r = await fetch(url, { headers:{ 'Accept':'application/json' } });
      if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json();
    }
    async function fetchNaturezas(){
      const list = await fetchJSON(`${API_BASE}/naturezas`);
      state.tax = [];
      for(const nat of list){
        const contas = await fetchJSON(`${API_BASE}/naturezas/${nat.code}/contas`);
        const contObjs = [];
        for(const acc of contas){
          let cats=[]; try{ cats = await fetchJSON(`${API_BASE}/contas/${acc.id}/categorias`);}catch(_){ cats=[]; }
          contObjs.push({ id:acc.id, nome:acc.nome, cats: cats.map(c=>c.nome), cats_full: cats.map(c=>({id:c.id, nome:c.nome})) });
        }
        state.tax.push({ code:nat.code, nome:nat.nome, contas: contObjs });
      }
    }
    async function fetchCentros(){
      const list = await fetchJSON(`${API_BASE}/centros`);
      state.centros = list.map(c=>({ id:c.id, nome:c.nome }));
    }
    async function createCentro(nome){
      try{
        const res = await fetch(window.API_BASE+`/centros`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ nome }) });
        if(!res.ok) throw new Error('Falha ao criar centro');
        return await res.json();
      }catch(err){
        console.warn('Fallback local: criando centro sem persistir no backend.', err);
        return { id: crypto.randomUUID(), nome };
      }
    }
    async function deleteCentro(id){
      try{ const res = await fetch(window.API_BASE+`/centros/${id}`, { method:'DELETE' }); if(!res.ok) throw new Error('Falha ao excluir centro'); }
      catch(err){ console.warn('Falha ao excluir no backend (talvez só local).', err); }
    }
    async function fetchLancamentos(){
      const list = await fetchJSON(`${API_BASE}/lancamentos`);
      state.lanc = list.map(item => {
        const nat = state.tax.find(n => n.code === item.natureza_code);
        const acc = nat?.contas.find(c => c.id === item.conta_id);
        const cat = acc?.cats_full.find(c => c.id === item.categoria_id);
        const centro = state.centros.find(c => c.id === item.centro_id);
        return {
          id: item.id,
          data: item.data,
          natureza: item.natureza_code,
          conta: acc?.nome || '',
          categoria: cat?.nome || '',
          centro: centro?.nome || '',
          pagamento: item.pagamento,
          descricao: item.descricao,
		  fornecedor_cliente: item.fornecedor_cliente || '',
          ir: !!item.ir,
          valor: Number(item.valor)||0,
          anexoNome: item.anexo_nome || null
        };
      });
    }
    async function postLancamento(item){
      try{
        const payload = {
          data: item.data, natureza_code: item.natureza_code,
          conta_id: item.conta_id ?? null, categoria_id: item.categoria_id ?? null, centro_id: item.centro_id ?? null,
          pagamento: item.pagamento ?? '',
	descricao: item.descricao ?? '',
	fornecedor_cliente: item.fornecedor_cliente ?? '',
	ir: !!item.ir,
	valor: item.valor,
	anexo_nome: item.anexoNome ?? null
        };
        const res = await fetch(window.API_BASE + `/lancamentos`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        if(!res.ok){ const errTxt = await res.text(); throw new Error(errTxt || `HTTP ${res.status}`); }
        return await res.json();
      }catch(err){ console.error('Erro ao salvar lançamento', err); return null; }
    }
    async function removeLancamento(id){
      try{ await fetch(window.API_BASE+`/lancamentos/${id}`, { method:'DELETE' }); }
      catch(err){ console.error('Erro ao excluir lançamento', err); }
    }
	async function updateLancamento(id, item){
		try{
		const payload = {
      data: item.data, natureza_code: item.natureza_code,
      conta_id: item.conta_id ?? null, categoria_id: item.categoria_id ?? null, centro_id: item.centro_id ?? null,
      pagamento: item.pagamento ?? '',
      descricao: item.descricao ?? '',
      fornecedor_cliente: item.fornecedor_cliente ?? '',
      ir: !!item.ir,
      valor: item.valor,
      anexo_nome: item.anexoNome ?? null
    };
    const res = await fetch(window.API_BASE + `/lancamentos/${id}`, {
      method:'PUT',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if(!res.ok){ throw new Error(await res.text()); }
    return await res.json();
  }catch(err){
    console.error('Erro ao atualizar lançamento', err);
    return null;
  }
}
    // ===== Helpers de selects =====
 function fillNatureza(){
    const elNat = document.getElementById('natureza');
    if (!elNat) return;
    elNat.innerHTML='';
    state.tax.forEach(n=>{
      const o=document.createElement('option');
      o.value=n.code; o.textContent=`${n.code} — ${n.nome}`;
      elNat.appendChild(o);
    });
  }
  function getNat(){
    const elNat = document.getElementById('natureza');
    return state.tax.find(n=> n.code === elNat?.value);
  }
  function fillContas(){
    const elConta = document.getElementById('conta');
    if (!elConta) return;
    elConta.innerHTML='';
    const nat=getNat();
    nat?.contas.forEach(c=>{
      const o=document.createElement('option');
      o.value=c.nome; o.textContent=c.nome;
      elConta.appendChild(o);
    });
    fillCategorias();
  }
  function fillCategorias(){
    const elConta = document.getElementById('conta');
    const elCat = document.getElementById('categoria');
    if (!elCat) return;
    elCat.innerHTML='';
    const nat=getNat();
    const conta = nat?.contas.find(c=> c.nome===elConta?.value);
    conta?.cats.forEach(cn=>{
      const o=document.createElement('option');
      o.value=cn; o.textContent=cn;
      elCat.appendChild(o);
    });
  }
  function fillCentros(){
    const elCentro = document.getElementById('centro');
    if (!elCentro) return;
    elCentro.innerHTML='';
    state.centros.forEach(c=>{
      const o=document.createElement('option');
      o.value=c.nome; o.textContent=c.nome;
      elCentro.appendChild(o);
    });
  }
    // ===== Tabs =====
  function activateTab(targetId) {
    const sections = ['lancamentos', 'extrato', 'categorias', 'demo'];
    const tabs = document.querySelectorAll('.tab');

    tabs.forEach(x => {
      x.classList.toggle('active', x.dataset.tab === targetId);
    });

    sections.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = (id === targetId)
        ? (id === 'lancamentos' ? 'grid' : 'block')
        : 'none';
    });

    // ganchos ao entrar na aba
    if (targetId === 'extrato') renderTabela?.();
    if (targetId === 'categorias') { renderPlanoContas?.(); renderCentrosTable?.(); }
    if (targetId === 'lancamentos') updateKPIs?.();
  }

  function enhanceTabsA11y() {
    document.querySelectorAll('.tab').forEach(t => {
      t.setAttribute('role', 'button');
      t.setAttribute('tabindex', '0');
      t.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          activateTab(t.dataset.tab);
        }
      });
    });
  }

  // ===== Inicialização segura =====
  window.addEventListener('DOMContentLoaded', () => {
    // 1) Preparar tabs com delegação de eventos
    const nav = document.querySelector('nav');
    if (nav) {
      nav.addEventListener('click', (e) => {
        const t = e.target.closest('.tab');
        if (!t) return;
        activateTab(t.dataset.tab);
      });
    }
    enhanceTabsA11y();

    // 2) Conectar listeners dos selects de forma segura
    const elNat   = document.getElementById('natureza');
    const elConta = document.getElementById('conta');
    const elCat   = document.getElementById('categoria');
    const elCentro= document.getElementById('centro');

    if (elNat)   elNat.addEventListener('change', () => { fillContas?.(); });
    if (elConta) elConta.addEventListener('change', () => { fillCategorias?.(); });

    // 3) Data/ano padrão (idempotente)
    const ano = document.getElementById('ano');
    if (ano) ano.textContent = new Date().getFullYear();
    const dataInput = document.getElementById('data');
    if (dataInput && !dataInput.value) dataInput.value = new Date().toISOString().slice(0,10);

    // 4) Carregar dados (com try/catch já existente em loadData)
    // Se der erro no backend, a UI (abas) continua funcional
    loadData?.();

    // 5) Ativar aba inicial explicitamente (evita ficar com display none, se algo mudou)
    activateTab('lancamentos');
  });

    // ===== Form Lançamento =====
    const elForm = {
      data: document.getElementById('data'),
      valor: document.getElementById('valor'),
      descricao: document.getElementById('descricao'),
	  fornecedor_cliente: document.getElementById('fornecedor_cliente'),
      pagamento: document.getElementById('pagamento'),
      ir: document.getElementById('impostoRenda'),
      anexo: document.getElementById('anexo')
    };
	
function buildPayloadFromForm() {
  const dataStr = elForm.data.value || new Date().toISOString().slice(0,10);

  const natEl    = document.getElementById('natureza');
  const contaEl  = document.getElementById('conta');
  const catEl    = document.getElementById('categoria');
  const centroEl = document.getElementById('centro');

  const natCode    = natEl?.value;
  const accName    = contaEl?.value || '';
  const catName    = catEl?.value || '';
  const centreName = centroEl?.value || 'Geral';

  const nat    = state.tax.find(n => n.code === natCode);
  const acc    = nat?.contas.find(c => c.nome === accName);
  const cat    = acc?.cats_full.find(cat => cat.nome === catName);
  const centre = state.centros.find(c => c.nome === centreName);

  return {
    data: dataStr,
    natureza_code: natCode,
    conta_id: acc ? acc.id : null,
    categoria_id: cat ? cat.id : null,
    centro_id: centre ? centre.id : null,
    pagamento: elForm.pagamento.value || '',
    descricao: elForm.descricao.value || '',
    fornecedor_cliente: elForm.fornecedor_cliente.value || '',
    ir: !!elForm.ir?.checked,
    valor: parseBR(elForm.valor.value),
    anexoNome: elForm.anexo.files[0]?.name || null
  };
}

// 2) Insere ou atualiza no estado local
function upsertLancamento(localData, saved) {
  const nat    = state.tax.find(n => n.code === saved.natureza_code);
  const acc    = nat?.contas.find(c => c.id === saved.conta_id);
  const cat    = acc?.cats_full.find(c => c.id === saved.categoria_id);
  const centre = state.centros.find(c => c.id === saved.centro_id);

  const item = {
    id: saved.id,
    data: saved.data,
    natureza: saved.natureza_code,
    conta: acc?.nome || '',
    categoria: cat?.nome || '',
    centro: centre?.nome || '',
    pagamento: saved.pagamento,
    descricao: saved.descricao,
    fornecedor_cliente: saved.fornecedor_cliente || '',
    ir: saved.ir,
    valor: Number(saved.valor) || 0,
    anexoNome: saved.anexo_nome || null
  };

  if (state.editingId) {
    // edição → substitui
    const idx = state.lanc.findIndex(l => l.id === state.editingId);
    if (idx >= 0) state.lanc[idx] = item;
    state.editingId = null;
  } else {
    // novo → adiciona no topo
    state.lanc.unshift(item);
  }
}

// 3) Handler do submit
document.getElementById('formLanc').addEventListener('submit', async (e) => {
  e.preventDefault();
  const payload = buildPayloadFromForm();

  let saved;
  if (state.editingId) {
    saved = await updateLancamento(state.editingId, payload);
  } else {
    saved = await postLancamento(payload);
  }

  if (saved) {
    upsertLancamento(payload, saved);
    updateKPIs(); renderTabela(); updateTreeWidget();
    document.getElementById('formLanc').reset();
    fillNatureza(); fillContas(); fillCentros();
    alert(state.editingId ? 'Lançamento atualizado!' : 'Lançamento salvo!');
  } else {
    alert('Erro ao salvar lançamento.');
  }
});

    elForm.valor.addEventListener('input', (e)=>{
      const raw=e.target.value.replace(/[^\d]/g,''); const num=(Number(raw)/100).toFixed(2);
      e.target.value = num.replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    });
  
    document.getElementById('limpar').addEventListener('click', ()=>{ 
		document.getElementById('formLanc').reset(); 
		fillNatureza(); fillContas(); fillCentros();});

    // ===== KPIs (mês atual) =====
    function updateKPIs(){
      const now=new Date(); const ym=now.toISOString().slice(0,7);
      const mes=state.lanc.filter(x=> x.data?.startsWith(ym));
      const sum=(arr,cond)=> arr.filter(cond).reduce((s,x)=>s+x.valor,0);
      const ro=sum(mes,x=>x.natureza==='RO'); const rno=sum(mes,x=>x.natureza==='RNO');
      const doo=sum(mes,x=>x.natureza==='DO'); const dno=sum(mes,x=>x.natureza==='DNO');
      document.getElementById('kpiRO').textContent=BRL.format(ro);
      document.getElementById('kpiRNO').textContent=BRL.format(rno);
      document.getElementById('kpiDO').textContent=BRL.format(doo);
      document.getElementById('kpiDNO').textContent=BRL.format(dno);
      document.getElementById('kpiSaldo').textContent=BRL.format(ro + rno - doo - dno);
    }

    // ===== Extrato =====
    const filtroMes=document.getElementById('filtroMes');
    const filtroNatureza=document.getElementById('filtroNatureza');
    const buscaTxt=document.getElementById('buscaTxt');
    [filtroMes,filtroNatureza,buscaTxt].forEach(x=> x.addEventListener('input', renderTabela));
    function renderTabela(){
      const tbody=document.querySelector('#tabela tbody'); if(!tbody) return;
      tbody.innerHTML=''; let arr=[...state.lanc];
      if(filtroMes.value) arr=arr.filter(x=> x.data?.startsWith(filtroMes.value));
      if(filtroNatureza.value) arr=arr.filter(x=> x.natureza===filtroNatureza.value);
      const q=buscaTxt.value?.toLowerCase?.()||'';
      if(q) arr=arr.filter(x=> (x.categoria+x.descricao+x.conta+x.centro+x.pagamento+x.fornecedor_cliente).toLowerCase().includes(q));
      arr.forEach(x=>{
        const tr=document.createElement('tr');
	tr.innerHTML = `
	<td>${fmtDate(x.data)}</td>
	<td>${x.natureza}</td>
	<td>${x.conta||'-'}</td>
	<td>${x.categoria||'-'}</td>
	<td>${x.centro||'-'}</td>
	<td>${x.fornecedor_cliente||'-'}</td>
	<td>${x.descricao||'-'}</td>
	<td style="font-weight:700">${BRL.format(x.valor)}</td>
	<td>${x.pagamento||'-'}</td>
	<td style="text-align:right">
    <button class="secondary" onclick="editar('${x.id}')">Editar</button>
    <button class="danger" onclick="excluir('${x.id}')">Excluir</button>
	</td>`;
        tbody.appendChild(tr);
      });
    }
	window.editar = async (id)=>{
	  const x=state.lanc.find(i=>i.id===id); 
	  if(!x) return;

	  state.editingId = id;  // guardamos qual lançamento está sendo editado
	  document.querySelector('[data-tab="lancamentos"]')?.click();

	  const natEl    = document.getElementById('natureza');
	  const contaEl  = document.getElementById('conta');
	  const catEl    = document.getElementById('categoria');
	  const centroEl = document.getElementById('centro');

	  elForm.data.value = x.data;
	  if (natEl){ natEl.value = x.natureza; fillContas(); }
	  if (contaEl){ contaEl.value = x.conta; fillCategorias(); }
	  if (catEl){ catEl.value = x.categoria; }
	  elForm.valor.value = BRL.format(x.valor).replace('R$\xa0','').trim();
	  fillCentros();
	  if (centroEl){ centroEl.value = x.centro; }
	  elForm.pagamento.value = x.pagamento || '';
	  elForm.fornecedor_cliente.value = x.fornecedor_cliente || '';
	  elForm.descricao.value = x.descricao || '';
	  elForm.ir.checked = !!x.ir;
	}

    window.excluir = async (id)=>{
      if(!confirm('Excluir este lançamento?')) return;
      await removeLancamento(id);
      state.lanc=state.lanc.filter(i=>i.id!==id);
      updateKPIs(); renderTabela(); updateTreeWidget();
    }

    // ===== Plano de Contas =====
    function renderPlanoContas(){
      const root=document.getElementById('pcTree'); root.innerHTML='';
      state.tax.forEach(n=>{
        const col=document.createElement('div'); col.className='card';
        const h=document.createElement('h3'); h.textContent=`${n.code} — ${n.nome}`; h.style.marginTop='0'; h.style.fontSize='16px'; col.appendChild(h);
        n.contas.forEach(c=>{
          const b=document.createElement('div'); b.style.margin='8px 0';
          const header=document.createElement('div'); header.className='inline';
          header.innerHTML = `<span style="font-weight:700">${c.nome}</span> <button class='secondary' onclick="uiRenameConta('${n.code}', '${c.nome.replace(/'/g,"&#39;")}')">Renomear</button> <button class='danger' onclick="uiDeleteConta('${n.code}', '${c.nome.replace(/'/g,"&#39;")}')">Excluir</button>`;
          b.appendChild(header);
          const ul=document.createElement('ul'); ul.style.margin='6px 0 0 16px'; ul.style.padding='0';
          c.cats.forEach(k=>{ const li=document.createElement('li'); li.textContent=k; li.style.margin='2px 0'; ul.appendChild(li); });
          b.appendChild(ul); col.appendChild(b);
        });
        root.appendChild(col);
      });
      fillPcSelectors();
    }
    const pcNat=document.getElementById('pcNat'); const pcConta=document.getElementById('pcConta');
    function fillPcSelectors(){ pcNat.innerHTML=''; state.tax.forEach(n=>{ const o=document.createElement('option'); o.value=n.code; o.textContent=`${n.code} — ${n.nome}`; pcNat.appendChild(o); }); fillPcContas(); }
    function fillPcContas(){ pcConta.innerHTML=''; const n=state.tax.find(x=> x.code===pcNat.value); n?.contas.forEach(c=>{ const o=document.createElement('option'); o.value=c.nome; o.textContent=c.nome; pcConta.appendChild(o); }); }
    pcNat.addEventListener('change', fillPcContas);
    document.getElementById('pcAddCat').addEventListener('click', ()=>{
      const nat=state.tax.find(x=> x.code===pcNat.value); const conta=nat?.contas.find(c=> c.nome===pcConta.value);
      const name=(document.getElementById('pcNovaCat').value||'').trim(); if(!name) return alert('Informe o nome da categoria');
      if(conta.cats.includes(name)) return alert('Categoria já existe nesta conta.'); conta.cats.push(name);
      document.getElementById('pcNovaCat').value=''; renderPlanoContas(); fillContas();
    });
    document.getElementById('pcAddConta').addEventListener('click', ()=>{
      const n=state.tax.find(x=> x.code===pcNat.value); const name=(document.getElementById('pcNovaConta').value||'').trim();
      if(!name) return alert('Informe o nome da conta');
      if(n.contas.some(c=> c.nome.toLowerCase()===name.toLowerCase())) return alert('Essa conta já existe nesta Natureza.');
      n.contas.push({nome:name, cats:[]}); document.getElementById('pcNovaConta').value='';
      renderPlanoContas(); fillContas(); fillPcContas();
    });
    document.getElementById('pcBtnRenomear').addEventListener('click', ()=>{
      const n=state.tax.find(x=> x.code===pcNat.value); const oldName=pcConta.value; const newName=(document.getElementById('pcRenomearConta').value||'').trim();
      if(!oldName) return alert('Selecione uma conta'); if(!newName) return alert('Digite o novo nome');
      if(n.contas.some(c=> c.nome.toLowerCase()===newName.toLowerCase())) return alert('Já existe uma conta com esse nome.');
      const conta=n.contas.find(c=> c.nome===oldName); conta.nome=newName;
      state.lanc.forEach(l=>{ if(l.natureza===n.code && l.conta===oldName){ l.conta=newName; } });
      document.getElementById('pcRenomearConta').value=''; renderPlanoContas(); fillContas(); fillPcContas(); alert('Conta renomeada e lançamentos reclassificados.');
    });
    document.getElementById('pcBtnExcluir').addEventListener('click', ()=>{
      const n=state.tax.find(x=> x.code===pcNat.value); const name=pcConta.value; if(!name) return alert('Selecione uma conta'); uiDeleteConta(n.code, name);
    });
    window.uiRenameConta = (natCode, name)=>{ pcNat.value = natCode; fillPcContas(); pcConta.value = name; document.getElementById('pcRenomearConta').focus(); }
    window.uiDeleteConta = (natCode, name)=>{
      const n=state.tax.find(x=> x.code===natCode);
      const depend = state.lanc.filter(l=> l.natureza===natCode && l.conta===name).length;
      let destino = null;
      if(depend>0){
        const outros = n.contas.map(c=>c.nome).filter(x=> x!==name);
        if(outros.length===0){ alert('Não é possível excluir: existe(m) lançamento(s) nessa conta e não há outra conta para reclassificar. Crie uma nova conta e tente novamente.'); return; }
        destino = prompt(`Encontrados ${depend} lançamento(s) em "${name}". Digite o nome da conta de destino dentre:\n- ${outros.join('\n- ')}`);
        if(!destino || !outros.includes(destino)){ alert('Operação cancelada.'); return; }
      }
      if(!confirm(`Excluir a conta "${name}" da Natureza ${n.nome}?`)) return;
      if(destino){ state.lanc.forEach(l=>{ if(l.natureza===natCode && l.conta===name){ l.conta = destino; } }); }
      if(destino){ const contaDst = n.contas.find(c=> c.nome===destino); const contaSrc = n.contas.find(c=> c.nome===name); contaSrc.cats.forEach(cat=>{ if(!contaDst.cats.includes(cat)) contaDst.cats.push(cat); }); }
      n.contas = n.contas.filter(c=> c.nome!==name); renderPlanoContas(); fillContas(); fillPcContas(); alert('Conta excluída com sucesso.');
    }

    // ===== Centros (na aba Plano de Contas) =====
    const tabCentrosBody = ()=> document.querySelector('#tabCentros tbody');
    function renderCentrosTable(){
      const tbody=tabCentrosBody(); if(!tbody) return;
      tbody.innerHTML='';
      state.centros.forEach((c,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${c.nome}</td><td style="text-align:right">${c.nome!=='Geral'?`<button class='danger' onclick='delCentro(${idx})'>Remover</button>`:''}</td>`;
        tbody.appendChild(tr);
      });
    }
    window.delCentro = async (idx)=>{
      if(!confirm('Remover este centro?')) return;
      const centro = state.centros[idx]; if(centro.nome==='Geral') return alert('Não é permitido remover "Geral".');
      try{ await deleteCentro(centro.id); } finally {
        state.lanc.forEach(l=>{ if(l.centro===centro.nome){ l.centro='Geral'; }});
        state.centros.splice(idx,1);
        renderCentrosTable(); fillCentros(); updateTreeWidget();
      }
    }
    document.getElementById('addCentro').addEventListener('click', async ()=>{
      const nome=document.getElementById('novoCentro').value.trim(); if(!nome) return alert('Informe o nome do centro');
      if(state.centros.some(c=>c.nome.toLowerCase()===nome.toLowerCase())) return alert('Centro já existe.');
      const created = await createCentro(nome); if(!created.id) created.id = crypto.randomUUID();
      state.centros.push({ id: created.id, nome: created.nome || nome });
      document.getElementById('novoCentro').value='';
      renderCentrosTable(); fillCentros(); updateTreeWidget();
    });

  // ===== Demonstrativo — integração com o widget =====
const NAT_LABEL = { RO:'Receita Operacional', RNO:'Receita Não Operacional', DO:'Despesa Operacional', DNO:'Despesa Não Operacional' };

function safraLabel(iso){
  const d = new Date(iso + 'T00:00:00'); const y = d.getFullYear(); const m = d.getMonth();
  const ini = (m>=7) ? y : (y-1); const fim = ini+1;
  return String(ini).slice(-2) + '-' + String(fim).slice(-2);
}

function buildTreeDataForWidget(){
  // Acumula: natureza -> conta -> categoria
  const tree = {};
  for (const x of state.lanc){
    const natureza = NAT_LABEL[x.natureza] || x.natureza || '(sem natureza)';
    const conta     = x.conta     || '(sem conta)';
    const categoria = x.categoria || '(sem categoria)';
    const centro    = x.centro    || 'Geral';
    const valor     = Number(x.valor)||0;
    const ano       = new Date(x.data + 'T00:00:00').getFullYear();
    const safra     = safraLabel(x.data);
	const mes = x.data.slice(0,7); 
    
	tree[natureza] ??= {};
    tree[natureza][conta] ??= {};
    tree[natureza][conta][categoria] ??= { cc:{}, ir:false, ano, safra, mes };
    tree[natureza][conta][categoria].cc[centro] = (tree[natureza][conta][categoria].cc[centro]||0) + valor;
    if (x.ir) tree[natureza][conta][categoria].ir = true;
  }

  // Converte para o formato esperado pelo widget
  return Object.entries(tree).map(([natureza, contasObj]) => ({
    natureza,
    // nível 1: o widget espera "categoria" -> aqui colocamos o NOME DA CONTA
    items: Object.entries(contasObj).map(([contaNome, categoriasObj]) => ({
      categoria: contaNome,
      // nível 2: folhas (cada item é uma "categoria")
      items: Object.entries(categoriasObj).map(([catNome, meta]) => ({
        conta: catNome,                     // folha mostra a CATEGORIA
        ccValues: meta.cc,
        flags: { impostoRenda: !!meta.ir },
        periodo: { safra: meta.safra, ano: meta.ano, mes: meta.mes }
      }))
    }))
  }));
}
  
  let treeApi = null;
  function mountTreeWidget(){
    const costCenters = state.centros.map(c=>c.nome);
    async function loadData(){ return buildTreeDataForWidget(); }
    if (window.DemonstrativoTreeWidget && typeof window.DemonstrativoTreeWidget.mount === 'function') {
      try {
        treeApi = DemonstrativoTreeWidget.mount('#demonstrativo_tree', { loadData, costCenters });
      } catch (err) {
        console.warn('Widget do demonstrativo falhou ao montar:', err);
        treeApi = null;
      }
    } else {
      console.warn('DemonstrativoTreeWidget indisponível; prosseguindo sem o widget.');
    }
  }

  function updateTreeWidget(){
    if(!treeApi) return;
    try {
      const costCenters = state.centros.map(c=>c.nome);
      const data = buildTreeDataForWidget();
      treeApi.setData(data, costCenters);
    } catch (err) {
      console.warn('Falha ao atualizar o widget:', err);
    }
  }

    // ===== Exportar / Importar CSV =====
    document.getElementById('exportCsv').addEventListener('click', ()=>{
const header = ['id','data','natureza','conta','categoria','descricao','fornecedor_cliente','centro','pagamento','ir','valor'];
const rows = state.lanc.map(x => header.map(h => {
  const v = x[h] ?? '';
  return typeof v === 'number' ? String(v).replace('.',',') : String(v).replace(/"/g,'""');
}));
      const csv=[header.join(';')].concat(rows.map(r=> r.join(';'))).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='sinuelo_finance.csv'; a.click();
    });
    document.getElementById('importCsvBtn').addEventListener('click', ()=> document.getElementById('importCsv').click());
    document.getElementById('importCsv').addEventListener('change', (e)=>{
      const file=e.target.files[0]; if(!file) return; const reader=new FileReader();
      reader.onload=()=>{
        const lines=reader.result.split(/\r?\n/).filter(Boolean); const header=lines.shift().split(';'); const idx=(name)=> header.indexOf(name);
        const arr=lines.map(l=>{
          const c=l.split(';');
     return {
  id: c[idx('id')]||crypto.randomUUID(),
  data: c[idx('data')],
  natureza: c[idx('natureza')]||c[idx('tipo')],
  conta: c[idx('conta')],
  categoria: c[idx('categoria')],
  descricao: c[idx('descricao')],
  fornecedor_cliente: c[idx('fornecedor_cliente')] || '',
  centro: c[idx('centro')],
  pagamento: c[idx('pagamento')],
  ir: ((c[idx('ir')]||'').toLowerCase()=='true' || c[idx('ir')]=='1'),
  valor: parseBR(c[idx('valor')]||'0')
};

        });
        state.lanc=arr.concat(state.lanc);
        updateKPIs(); renderTabela(); updateTreeWidget();
        alert('Importado! Abra o Extrato/Demonstrativos para conferir.');
      };
      reader.readAsText(file,'utf-8');
    });

    // ===== Carregamento inicial =====
    async function loadData(){
      document.getElementById('err').style.display='none';
      try{
        await fetchNaturezas(); await fetchCentros(); await fetchLancamentos();

        // Filtros do extrato
        const filtroNaturezaSel = document.getElementById('filtroNatureza');
        filtroNaturezaSel.innerHTML = '<option value="">Todas</option>';
        state.tax.forEach(n=>{ const o=document.createElement('option'); o.value=n.code; o.textContent=`${n.code} — ${n.nome}`; filtroNaturezaSel.appendChild(o); });

        // UI
        fillNatureza(); fillContas(); fillCentros(); renderPlanoContas(); renderCentrosTable();
        updateKPIs(); renderTabela();

        // Árvore
        mountTreeWidget(); updateTreeWidget();
      }catch(e){
        const el= document.getElementById('err');
        el.textContent = 'Falha ao carregar dados do demonstrativo.\n- Verifique se a API está acessível em '+API_BASE+'\n- Se estiver usando outro domínio, confira CORS no backend.\nDetalhes: '+ (e && e.message ? e.message : e);
        el.style.display='block';
       }
    }

  </script>
</body>
</html>

