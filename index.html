<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/favicon.ico" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <title>Sinuelo Finance — Protótipo</title>
  <!-- Estilos básicos do protótipo -->
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#06b6d4; --danger:#ef4444; --shadow:0 10px 25px rgba(0,0,0,.35); --radius:16px }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Noto Sans,Arial; color:var(--text); background:linear-gradient(180deg,#0b1220 0%,#0f172a 100%); min-height:100svh}
    header{position:sticky; top:0; z-index:10; background:rgba(15,23,42,.8); backdrop-filter:saturate(1.2) blur(10px); border-bottom:1px solid rgba(255,255,255,.06)}
    .container{max-width:1100px; margin:0 auto; padding:16px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:36px; height:36px; border-radius:12px; background:radial-gradient(circle at 30% 30%, var(--accent) 0%, #16a34a 35%, #164e63 100%); box-shadow:var(--shadow)}
    h1{font-size:20px; margin:0; letter-spacing:.3px}
    nav{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; align-items:center}
    .tab{border:1px solid rgba(255,255,255,.08); background:#0b1220; color:var(--text); padding:10px 14px; border-radius:999px; cursor:pointer}
    .tab.active{background:var(--accent-2); color:#001015; border-color:transparent; font-weight:600}
    .install{margin-left:auto; display:flex; gap:8px; align-items:center}
    .install button{background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.18)}
    .grid{display:grid; gap:16px; grid-template-columns:1fr}
    @media (min-width: 900px){ .grid{grid-template-columns:1.1fr .9fr} }
    .card{background:rgba(17,24,39,.75); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)}
    .card h2{margin:4px 0 12px 0; font-size:18px}
    label{font-size:12px; color:var(--muted)}
    input, select, textarea{width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0b1220; color:var(--text)}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:700px){.row.cols-2{grid-template-columns:1fr 1fr}}
    @media(min-width:900px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}}
    button{appearance:none; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; background:var(--accent); color:#052e16; font-weight:700; box-shadow:var(--shadow)}
    button.secondary{background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.1)}
    button.danger{background:var(--danger); color:#310808}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
    .kpi{background:#0b1220;border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:20px; font-weight:800; margin-top:4px}
    table{width:100%; border-collapse:collapse}
    th, td{ padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left; font-size:14px}
    th{color:var(--muted); font-weight:600}
    tr:hover{background:rgba(255,255,255,.03)}
    footer{color:var(--muted); font-size:12px; text-align:center; padding:24px}
    @media (display-mode: standalone){ body{background:#0f172a} }
    .small{font-size:12px;color:var(--muted)}
    .inline{display:inline-flex; gap:8px; align-items:center}
  </style>
</head>
<body>
  <!-- Cabeçalho e navegação -->
  <header>
    <div class="container">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Agropecuária Sinuelo — Finance</h1>
          <div style="font-size:12px; color:var(--muted)">v0.5 • Natureza → Conta → Categoria (com criar/renomear/excluir contas) + rateio</div>
        </div>
      </div>
      <nav style="margin-top:14px">
        <div class="tab active" data-tab="lancamentos">Lançamentos</div>
        <div class="tab" data-tab="extrato">Extrato</div>
        <div class="tab" data-tab="categorias">Plano de Contas</div>
        <div class="tab" data-tab="demo">Demonstrativos</div>
        <div class="tab" data-tab="config">Configurações</div>
        <div class="install">
          <button id="btnInstall" style="display:none">Instalar app</button>
          <span id="installHint" style="font-size:12px; color:var(--muted); display:none">Use ⋮ → Adicionar à tela inicial</span>
        </div>
      </nav>
    </div>
  </header>

  <!-- Conteúdo principal -->
  <main class="container" style="padding-top:18px">
    <!-- Seção de lançamentos -->
    <section id="lancamentos" class="grid">
      <div class="card">
        <h2>Novo lançamento</h2>
        <form id="formLanc" autocomplete="off">
          <div class="row cols-3">
            <div>
              <label for="data">Data</label>
              <input type="date" id="data" required />
            </div>
            <div>
              <label for="natureza">Natureza</label>
              <select id="natureza" required></select>
            </div>
            <div>
              <label for="valor">Valor (R$)</label>
              <input inputmode="decimal" id="valor" placeholder="0,00" required />
            </div>
          </div>

          <div class="row cols-3" style="margin-top:12px">
            <div>
              <label for="conta">Conta</label>
              <select id="conta"></select>
            </div>
            <div>
              <label for="categoria">Categoria</label>
              <select id="categoria"></select>
            </div>
            <div>
              <label for="centro">Centro de Custo</label>
              <select id="centro"></select>
            </div>
          </div>

          <div class="row cols-2" style="margin-top:12px">
            <div>
              <label for="descricao">Descrição</label>
              <input id="descricao" placeholder="Ex.: Venda bezerros, ração, adubo..." />
            </div>
            <div>
              <label for="pagamento">Forma de pagamento</label>
              <select id="pagamento">
                <option>Pix</option>
                <option>Dinheiro</option>
                <option>Cartão</option>
                <option>Boleto</option>
                <option>Transferência</option>
                <option>Nota a pagar/receber</option>
              </select>
            </div>
          </div>

          <!-- Único checkbox de Imposto de Renda -->
          <div class="row" style="margin-top:8px">
            <label class="inline"><input type="checkbox" id="impostoRenda" style="width:auto;margin-right:8px"> Marcar como "Imposto de Renda"</label>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <label for="anexo">Anexo (foto ou PDF da nota)</label>
              <input type="file" id="anexo" accept="image/*,.pdf" />
            </div>
          </div>

          <div class="btns" style="margin-top:16px">
            <button type="submit">Salvar lançamento</button>
            <button type="button" class="secondary" id="limpar">Limpar</button>
          </div>
        </form>
      </div>

      <!-- Resumo rápido (KPIs) -->
      <div class="card">
        <h2>Resumo rápido (mês)</h2>
        <div class="kpis">
          <div class="kpi"><div class="label">Receita Operacional</div><div class="value" id="kpiRO">R$ 0,00</div></div>
          <div class="kpi"><div class="label">Receita Não Operac.</div><div class="value" id="kpiRNO">R$ 0,00</div></div>
          <div class="kpi"><div class="label">Despesa Operacional</div><div class="value" id="kpiDO">R$ 0,00</div></div>
          <div class="kpi"><div class="label">Despesa Não Operac.</div><div class="value" id="kpiDNO">R$ 0,00</div></div>
        </div>
        <div style="margin-top:8px; font-size:13px; color:var(--muted)">Saldo: <b id="kpiSaldo">R$ 0,00</b></div>
        <div style="margin-top:16px" class="btns">
          <button type="button" class="secondary" id="exportCsv">Exportar CSV</button>
          <button type="button" class="secondary" id="importCsvBtn">Importar CSV</button>
          <input type="file" id="importCsv" accept="text/csv" style="display:none" />
        </div>
      </div>
    </section>

    <!-- Seção do extrato -->
    <section id="extrato" class="card" style="display:none">
      <div class="row cols-3">
        <div>
          <label for="filtroMes">Mês</label>
          <input type="month" id="filtroMes" />
        </div>
        <div>
          <label for="filtroNatureza">Natureza</label>
          <select id="filtroNatureza"><option value="">Todas</option></select>
        </div>
        <div>
          <label for="buscaTxt">Busca</label>
          <input id="buscaTxt" placeholder="Descrição, categoria, conta, centro..." />
        </div>
      </div>
      <div style="overflow:auto; margin-top:12px">
        <table id="tabela">
          <thead>
            <tr>
              <th>Data</th>
              <th>Natureza</th>
              <th>Conta</th>
              <th>Categoria</th>
              <th>Descrição</th>
              <th>Centro</th>
              <th>Pagamento</th>
              <th>Valor</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Seção Plano de Contas -->
    <section id="categorias" class="card" style="display:none">
      <h2>Plano de Contas (Natureza → Conta → Categoria)</h2>
      <div id="pcTree" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px"></div>
      <div class="row cols-3" style="margin-top:12px">
        <div>
          <label>Natureza</label>
          <select id="pcNat"></select>
        </div>
        <div>
          <label>Conta</label>
          <select id="pcConta"></select>
        </div>
        <div class="btns" style="align-items:end">
          <input id="pcNovaCat" placeholder="Nova categoria" />
          <button id="pcAddCat">Adicionar categoria</button>
        </div>
      </div>
      <div class="row cols-3" style="margin-top:8px">
        <div class="btns" style="align-items:end">
          <input id="pcNovaConta" placeholder="Nova conta" />
          <button id="pcAddConta">Adicionar conta</button>
        </div>
        <div class="btns" style="align-items:end">
          <input id="pcRenomearConta" placeholder="Novo nome da conta selecionada" />
          <button id="pcBtnRenomear">Renomear conta</button>
        </div>
        <div class="btns" style="align-items:end">
          <button class="danger" id="pcBtnExcluir">Excluir conta selecionada</button>
        </div>
      </div>
      <div class="small" style="margin-top:6px">Ao excluir uma conta com lançamentos, os lançamentos serão <b>reclassificados</b> para outra conta da mesma Natureza (você poderá escolher).</div>
    </section>

    <!-- Seção de demonstrativos -->
    <section id="demo" class="card" style="display:none">
      <h2>Demonstrativos por Centro (rateio do "Geral")</h2>
      <div class="row cols-3">
        <div>
          <label>Tipo de demonstrativo</label>
          <select id="demoTipo">
            <option value="safra">Safra (agosto a julho)</option>
            <option value="ano">Ano (janeiro a dezembro)</option>
          </select>
        </div>
        <div id="demoPeriodo">
          <label id="lblPeriodo">Safra (agosto a julho)</label>
          <input type="number" id="demoSafra" min="2000" step="1" />
          <div class="small" id="helpPeriodo">Ex.: 2024 — considera 01/08/2024 a 31/07/2025</div>
          <label class="inline" id="wrapIr" style="display:none;margin-top:6px"><input type="checkbox" id="demoIrOnly" style="width:auto;margin-right:8px"> Somente "Imposto de Renda"</label>
        </div>
        <div>
          <label>Área Total da Fazenda (ha)</label>
          <input type="number" id="areaTotal" min="0" step="0.01" />
        </div>
      </div>
      <!-- Novo seletor de centro de custo para demonstrativo -->
      <div class="row cols-3" style="margin-top:8px">
        <div>
          <label>Centro de Custo</label>
          <select id="demoCentro">
            <option value="Todos">Todos</option>
          </select>
        </div>
      </div>
      <div style="overflow:auto; margin-top:12px">
        <table id="tabDemo">
          <thead><tr id="demoHeader"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="small">Tudo lançado em <b>Geral</b> é rateado proporcionalmente à área dos demais centros (exclui-se "Geral").</p>
    </section>

    <!-- Seção de configurações -->
    <section id="config" class="card" style="display:none">
      <h2>Configurações</h2>
      <div class="row cols-2">
        <div>
          <h3 style="margin:0 0 8px 0; font-size:16px">Centros de Custo</h3>
          <div class="row cols-3">
            <div>
              <label>Novo centro</label>
              <input id="novoCentro" placeholder="Ex.: Agricultura de Precisão" />
            </div>
            <div>
              <label>Área (ha)</label>
              <input id="novoCentroArea" type="number" min="0" step="0.01" />
            </div>
            <div class="btns" style="align-items:end"><button id="addCentro">Adicionar</button></div>
          </div>
          <div style="overflow:auto; margin-top:12px">
            <table id="tabCentros">
              <thead><tr><th>Centro</th><th>Área (ha)</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <p style="color:var(--muted); font-size:14px; line-height:1.5">
            Dados salvos apenas no <strong>navegador</strong> (teste). Centros iniciais: <b>Geral</b>, <b>Soja</b>, <b>Bovinos</b>, <b>Ovinos</b>.
          </p>
          <div class="btns"><button class="danger" id="apagarTudo">Apagar todos os dados (teste)</button></div>
        </div>
      </div>
    </section>
  </main>

  <footer>© <span id="ano"></span> Agropecuária Sinuelo • Protótipo</footer>

  <!-- Scripts -->
  <script>
    // ===== PWA =====
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(console.warn)); }
    let deferredPrompt; const btnInstall=document.getElementById('btnInstall'); const installHint=document.getElementById('installHint');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; btnInstall.style.display='inline-flex'; installHint.style.display='none'; });
    btnInstall?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; btnInstall.style.display='none'; });
    window.addEventListener('appinstalled', ()=> btnInstall.style.display='none'); setTimeout(()=>{ if(btnInstall && btnInstall.style.display==='none'){ installHint.style.display='inline'; } }, 2500);

    // ===== Utils =====
    const BRL = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const parseBR = (s)=> Number(String(s).replace(/\./g,'').replace(',','.')) || 0;
    const fmtDate = (iso)=> new Date(iso + 'T00:00:00').toLocaleDateString('pt-BR');

    // ===== Estado =====
    const state = {
      lanc: JSON.parse(localStorage.getItem('sinuelo_lanc')||'[]'),
      centros: JSON.parse(localStorage.getItem('sinuelo_centros')||'[]'),
      areaTotal: Number(localStorage.getItem('sinuelo_area_total')||'0'),
      tax: JSON.parse(localStorage.getItem('sinuelo_tax')||'null')
    };

    // Migração antigo -> novo (caso existam campos 'tipo')
    if(state.lanc.length && state.lanc[0].tipo && !state.lanc[0].natureza){
      state.lanc = state.lanc.map(x=> ({...x, natureza:x.tipo, conta:x.conta||'', categoria:x.categoria||x.categoria, tipo:undefined }));
    }

    // Plano de contas padrão
    const TAX_DEFAULT = [
      { code:'RO', nome:'RECEITAS OPERACIONAIS', contas:[
        {nome:'PECUÁRIA', cats:['VENDAS DE BOVINOS','VENDAS DE OVINOS','OUTRAS']},
        {nome:'ALUGUÉIS E ARRENDAMENTOS', cats:['PASTOS']},
        {nome:'AGRICULTURA', cats:['SOJA','MILHO','SORGO','FENO']},
        {nome:'OUTROS', cats:['INDENIZAÇÃO E REPAROS','SERVIÇOS PRESTADOS','SEGUROS','VENDA DE EQUIPAMENTOS']}
      ]},
      { code:'RNO', nome:'RECEITAS NÃO OPERACIONAIS', contas:[
        {nome:'RECEITAS NÃO OPERACIONAIS', cats:['EMPRÉSTIMOS TERCEIROS','APORTE EDUARDO PAIM','APORTE ROBERTO PAIM','JUROS E CORREÇÕES','VENDA DE INSUMOS','FINANCIAMENTO BANCÁRIO','CRÉDITOS EMPRESAS INSUMOS','CRÉDITOS EMPRESAS MÁQUINAS','OUTROS']}
      ]},
      { code:'DO', nome:'DESPESAS OPERACIONAIS', contas:[
        {nome:'MÃO DE OBRA', cats:['SALÁRIOS','ENCARGOS E BENEFÍCIOS','MÃO DE OBRA EVENTUAL','ALIMENTAÇÃO','HORAS EXTRAS/DESC.REMUNERADO','UNIFORMES','SALÁRIO EDUARDO PAIM']},
        {nome:'INSUMOS BOVINOS', cats:['SAL MINERAL','RAÇÕES E SUPLEMENTAÇÃO','MEDICAMENTOS E VACINAS','MATERIAIS E FERRAMENTAS','INSEMINAÇÃO - SÊMEN','INSEMINAÇÃO - NITROGÊNIO','SERVIÇOS - IATF','FRETES','COMISSÕES','VETERINÁRIO E EXAMES','OUTROS']},
        {nome:'INSUMOS OVINOS', cats:['SAL MINERAL','RAÇÕES E SUPLEMENTAÇÃO','MEDICAMENTOS E VACINAS','MATERIAIS E FERRAMENTAS','FRETES','COMISSÕES','VETERINÁRIO E EXAMES','OUTROS']},
        {nome:'MANUTENÇÃO DE INSTALAÇÕES', cats:['EMPREITEIROS','INSUMO E MATERIAIS','OUTROS']},
        {nome:'PASTAGENS', cats:['SEMENTE E MUDAS','ADUBOS E FERTILIZANTES','DEFENSIVOS E HERBICIDAS','MATERIAIS E FERRAMENTAS','OUTROS']},
        {nome:'MANUTENÇÃO DE MÁQUINAS E VEÍCULOS', cats:['DO-MANUTENÇÃO MÁQUINAS-TRATOR MF 4275','DO-MANUTENÇÃO MÁQUINAS-TRATOR MF 4292','DO-MANUTENÇÃO MÁQUINAS-TRATOR CASE 180','DO-MANUTENÇÃO MÁQUINAS-TRATOR MF 65X','DO-MANUTENÇÃO MÁQUINAS-TRATOR JD 5078','DO-MANUTENÇÃO MÁQUINAS-PA XCMG ZL30BR','DO-MANUTENÇÃO MÁQUINAS-COLHEDadeira 1550','DO-MANUTENÇÃO MÁQUINAS-COLHEDadeira 7500','DO-MANUTENÇÃO MÁQUINAS-PLANTADEIRA MF','DO-MANUTENÇÃO MÁQUINAS-PULVERIZADOR 3000 ADVANCED','DO-MANUTENÇÃO MÁQUINAS-IMPLEMENTOS','DO-MANUTENÇÃO MÁQUINAS-VEÍCULOS','DO-MANUTENÇÃO MÁQUINAS-MOTO','DO-MANUTENÇÃO MÁQUINAS-INSUMOS','DO-MANUTENÇÃO MÁQUINAS-LUBRIFICANTES, FILTROS E GRAXAS','OUTROS']},
        {nome:'GRÃOS', cats:['SEMENTES','ADUBOS E FERTILIZANTES','INOCULANTES','ADUBOS FOLIARES','INSETICIDAS','FUNGICIDAS','HERBICIDAS','ÓLEO E REDUTOR DE PH','TRATAMENTO DE SEMENTE','MÃO-DE-OBRA','INSUMOS E MATERIAIS','SERV. TERCERIZADOS','TRANSPORTES E FRETES','ARMAZENAGEM E SECAGEM','ASSISTÊNCIA TÉCNICA','CORREÇÃO DO SOLO','DIVERSOS']},
        {nome:'ADMINISTRATIVO', cats:['IMPOSTO, TAXAS E LICENÇAS','ESCRITÓRIO','PROFISSIONAIS ESPECIALIZADOS','JUROS, MULTAS, CORREÇÕES e IOF','CARTÓRIO E REGISTROS','SEGUROS','ENERGIA','ALIMENTAÇÃO CASA SEDE','TELEFONE + INTERNET','ANIMAIS DOMÉSTICOS','COMBUSTÍVEL VEÍCULO','CURSOS E TREINAMENTOS','FUNRURAL/SENAR','DOAÇÕES','OUTROS','RAÇÕES E INSUMOS - AVES E SUÍNOS','COMBUSTÍVEL MÁQUINAS']}
      ]},
      { code:'DNO', nome:'DESPESAS NÃO OPERACIONAIS', contas:[
        {nome:'COMPRA DE SEMOVENTES', cats:['BOVINOS','EQUINOS','OVINOS','FRETES E COMISSÕES']},
        {nome:'INVESTIMENTO EM EXPANSÃO', cats:['MÁQUINAS','BENFEITORIAS','CERCAS','MOBILIÁRIO','FERRAMENTAS','CORREÇÃO DO SOLO']},
        {nome:'FINANCIAMENTOS', cats:['EMPRÉSTIMOS TERCEIROS','EMPRÉSTIMOS ROBERTO PAIM','EMPRÉSTIMOS EDUARDO PAIM','PAGAMENTOS EMPRESAS MÁQUINAS','PAGAMENTOS EMPRESAS INSUMOS','FINANC BANCÁRIO MÁQUINAS','FINANC BANCÁRIO CUSTEIO AGRÍCOLA/PECUÁRIO','FINANC BANCÁRIO INVESTIMENTOS','DESCONTOS, DEVOLUÇÃO E ACERTOS','OUTROS']}
      ]}
    ];

    // Inicializa state.tax se ainda não existir ou estiver vazio
    if(!Array.isArray(state.tax) || state.tax.length===0){
      state.tax = JSON.parse(JSON.stringify(TAX_DEFAULT));
      persist();
    }

    // Centros default (adiciona se lista vazia)
    if(state.centros.length === 0){ state.centros = [ {nome:'Geral', area:0}, {nome:'Soja', area:0}, {nome:'Bovinos', area:0}, {nome:'Ovinos', area:0} ]; persist(); }

    // ===== Persistência =====
    function persist(){
      localStorage.setItem('sinuelo_lanc', JSON.stringify(state.lanc));
      localStorage.setItem('sinuelo_centros', JSON.stringify(state.centros));
      localStorage.setItem('sinuelo_area_total', String(state.areaTotal||0));
      localStorage.setItem('sinuelo_tax', JSON.stringify(state.tax));
    }

    // ===== UI Helpers (Plano de Contas) =====
    const elNat = document.getElementById('natureza');
    const elConta = document.getElementById('conta');
    const elCat = document.getElementById('categoria');
    const elCentro = document.getElementById('centro');

    function fillNatureza(){ elNat.innerHTML=''; state.tax.forEach(n=>{ const o=document.createElement('option'); o.value=n.code; o.textContent=`${n.code} — ${n.nome}`; elNat.appendChild(o); }); }
    function getNat(){ return state.tax.find(n=> n.code===elNat.value) }
    function fillContas(){ elConta.innerHTML=''; const nat=getNat(); nat?.contas.forEach(c=>{ const o=document.createElement('option'); o.value=c.nome; o.textContent=c.nome; elConta.appendChild(o); }); fillCategorias(); }
    function fillCategorias(){ elCat.innerHTML=''; const nat=getNat(); const conta = nat?.contas.find(c=> c.nome===elConta.value); conta?.cats.forEach(cn=>{ const o=document.createElement('option'); o.value=cn; o.textContent=cn; elCat.appendChild(o); }); }
    function fillCentros(){ elCentro.innerHTML=''; state.centros.forEach(c=>{ const o=document.createElement('option'); o.value=c.nome; o.textContent=c.nome; elCentro.appendChild(o); }); }

    elNat.addEventListener('change', fillContas);
    elConta.addEventListener('change', fillCategorias);

    // ===== Tabs =====
    const tabs = document.querySelectorAll('.tab');
    const sections = ['lancamentos','extrato','categorias','demo','config'];
    tabs.forEach(t=> t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      sections.forEach(id => document.getElementById(id).style.display = id===t.dataset.tab ? (id==='lancamentos'?'grid':'block') : 'none');
      if(t.dataset.tab==='extrato') renderTabela();
      if(t.dataset.tab==='categorias') renderPlanoContas();
      if(t.dataset.tab==='lancamentos') updateKPIs();
      if(t.dataset.tab==='config') { renderCentros(); }
      if(t.dataset.tab==='demo') { document.getElementById('areaTotal').value = state.areaTotal || 0; renderDemo(); }
    }));

    // ===== Form Lançamento =====
    const elForm = {
      data: document.getElementById('data'),
      valor: document.getElementById('valor'),
      descricao: document.getElementById('descricao'),
      pagamento: document.getElementById('pagamento'),
      ir: document.getElementById('impostoRenda'),
      anexo: document.getElementById('anexo')
    };

    // Máscara de valor (R$)
    elForm.valor.addEventListener('input', (e)=>{
      const raw=e.target.value.replace(/[^\d]/g,'');
      const num=(Number(raw)/100).toFixed(2);
      e.target.value = num.replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    });

    document.getElementById('formLanc').addEventListener('submit', (e)=>{
      e.preventDefault();
      const item = {
        id: crypto.randomUUID(),
        data: elForm.data.value || new Date().toISOString().slice(0,10),
        natureza: elNat.value,
        conta: elConta.value||'',
        categoria: elCat.value||'',
        centro: elCentro.value||'Geral',
        pagamento: elForm.pagamento.value||'',
        descricao: elForm.descricao.value||'',
        ir: !!elForm.ir?.checked,
        valor: parseBR(elForm.valor.value),
        anexoNome: elForm.anexo.files[0]?.name || null
      };
      state.lanc.unshift(item);
      persist();
      document.getElementById('formLanc').reset();
      fillNatureza(); fillContas(); fillCentros(); updateKPIs();
      alert('Lançamento salvo!');
    });
    document.getElementById('limpar').addEventListener('click', ()=>{
      document.getElementById('formLanc').reset(); fillNatureza(); fillContas();
    });

    // ===== KPIs (mês atual) =====
    function updateKPIs(){
      const now=new Date();
      const ym=now.toISOString().slice(0,7);
      const mes=state.lanc.filter(x=> x.data?.startsWith(ym));
      const sum=(arr,cond)=> arr.filter(cond).reduce((s,x)=>s+x.valor,0);
      const ro=sum(mes,x=>x.natureza==='RO');
      const rno=sum(mes,x=>x.natureza==='RNO');
      const doo=sum(mes,x=>x.natureza==='DO');
      const dno=sum(mes,x=>x.natureza==='DNO');
      document.getElementById('kpiRO').textContent=BRL.format(ro);
      document.getElementById('kpiRNO').textContent=BRL.format(rno);
      document.getElementById('kpiDO').textContent=BRL.format(doo);
      document.getElementById('kpiDNO').textContent=BRL.format(dno);
      document.getElementById('kpiSaldo').textContent=BRL.format(ro + rno - doo - dno);
    }

    // ===== Extrato =====
    const filtroMes=document.getElementById('filtroMes');
    const filtroNatureza=document.getElementById('filtroNatureza');
    const buscaTxt=document.getElementById('buscaTxt');
    [filtroMes,filtroNatureza,buscaTxt].forEach(x=> x.addEventListener('input', renderTabela));
    function renderTabela(){
      const tbody=document.querySelector('#tabela tbody');
      tbody.innerHTML='';
      let arr=[...state.lanc];
      if(filtroMes.value) arr=arr.filter(x=> x.data?.startsWith(filtroMes.value));
      if(filtroNatureza.value) arr=arr.filter(x=> x.natureza===filtroNatureza.value);
      const q=buscaTxt.value?.toLowerCase?.()||'';
      if(q) arr=arr.filter(x=> (x.categoria+x.descricao+x.conta+x.centro+x.pagamento).toLowerCase().includes(q));
      arr.forEach(x=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${fmtDate(x.data)}</td><td>${x.natureza}</td><td>${x.conta||'-'}</td><td>${x.categoria||'-'}</td><td>${x.descricao||'-'}</td><td>${x.centro||'-'}</td><td>${x.pagamento||'-'}</td><td style="font-weight:700">${BRL.format(x.valor)}</td><td style="text-align:right"><button class="secondary" onclick="editar('${x.id}')">Editar</button> <button class="danger" onclick="excluir('${x.id}')">Excluir</button></td>`;
        tbody.appendChild(tr);
      });
    }
    window.editar = (id)=>{
      const x=state.lanc.find(i=>i.id===id);
      if(!x) return;
      document.querySelector('[data-tab="lancamentos"]').click();
      elForm.data.value=x.data;
      elNat.value=x.natureza;
      fillContas();
      elConta.value=x.conta;
      fillCategorias();
      elCat.value=x.categoria;
      elForm.valor.value=BRL.format(x.valor).replace('R$\xa0','').trim();
      fillCentros();
      elCentro.value=x.centro;
      elForm.pagamento.value=x.pagamento;
      elForm.descricao.value=x.descricao;
      elForm.ir.checked=!!x.ir;
      state.lanc=state.lanc.filter(i=>i.id!==id);
      persist(); updateKPIs();
    }
    window.excluir = (id)=>{
      if(!confirm('Excluir este lançamento?')) return;
      state.lanc=state.lanc.filter(i=>i.id!==id);
      persist(); renderTabela(); updateKPIs();
    }

    // ===== Plano de Contas (visual + CRUD de contas e categorias) =====
    function renderPlanoContas(){
      const root=document.getElementById('pcTree');
      root.innerHTML='';
      state.tax.forEach(n=>{
        const col=document.createElement('div');
        col.className='card';
        const h=document.createElement('h3');
        h.textContent=`${n.code} — ${n.nome}`;
        h.style.marginTop='0';
        h.style.fontSize='16px';
        col.appendChild(h);
        n.contas.forEach(c=>{
          const b=document.createElement('div');
          b.style.margin='8px 0';
          const header=document.createElement('div');
          header.className='inline';
          header.innerHTML = `<span style="font-weight:700">${c.nome}</span> <button class='secondary' onclick="uiRenameConta('${n.code}', '${c.nome.replace(/'/g,"&#39;")}')">Renomear</button> <button class='danger' onclick="uiDeleteConta('${n.code}', '${c.nome.replace(/'/g,"&#39;")}')">Excluir</button>`;
          b.appendChild(header);
          const ul=document.createElement('ul');
          ul.style.margin='6px 0 0 16px';
          ul.style.padding='0';
          c.cats.forEach(k=>{
            const li=document.createElement('li');
            li.textContent=k;
            li.style.margin='2px 0';
            ul.appendChild(li);
          });
          b.appendChild(ul);
          col.appendChild(b);
        });
        root.appendChild(col);
      });
      fillPcSelectors();
    }
    const pcNat=document.getElementById('pcNat');
    const pcConta=document.getElementById('pcConta');
    function fillPcSelectors(){
      pcNat.innerHTML='';
      state.tax.forEach(n=>{
        const o=document.createElement('option');
        o.value=n.code;
        o.textContent=`${n.code} — ${n.nome}`;
        pcNat.appendChild(o);
      });
      fillPcContas();
    }
    function fillPcContas(){
      pcConta.innerHTML='';
      const n=state.tax.find(x=> x.code===pcNat.value);
      n?.contas.forEach(c=>{
        const o=document.createElement('option');
        o.value=c.nome;
        o.textContent=c.nome;
        pcConta.appendChild(o);
      });
    }
    pcNat.addEventListener('change', fillPcContas);

    document.getElementById('pcAddCat').addEventListener('click', ()=>{
      const nat=state.tax.find(x=> x.code===pcNat.value);
      const conta=nat?.contas.find(c=> c.nome===pcConta.value);
      const name=(document.getElementById('pcNovaCat').value||'').trim();
      if(!name) return alert('Informe o nome da categoria');
      if(conta.cats.includes(name)) return alert('Categoria já existe nesta conta.');
      conta.cats.push(name);
      document.getElementById('pcNovaCat').value='';
      persist(); renderPlanoContas(); fillContas();
    });
    document.getElementById('pcAddConta').addEventListener('click', ()=>{
      const n=state.tax.find(x=> x.code===pcNat.value);
      const name=(document.getElementById('pcNovaConta').value||'').trim();
      if(!name) return alert('Informe o nome da conta');
      if(n.contas.some(c=> c.nome.toLowerCase()===name.toLowerCase())) return alert('Essa conta já existe nesta Natureza.');
      n.contas.push({nome:name, cats:[]});
      document.getElementById('pcNovaConta').value='';
      persist(); renderPlanoContas(); fillContas(); fillPcContas();
    });
    document.getElementById('pcBtnRenomear').addEventListener('click', ()=>{
      const n=state.tax.find(x=> x.code===pcNat.value);
      const oldName=pcConta.value;
      const newName=(document.getElementById('pcRenomearConta').value||'').trim();
      if(!oldName) return alert('Selecione uma conta');
      if(!newName) return alert('Digite o novo nome');
      if(n.contas.some(c=> c.nome.toLowerCase()===newName.toLowerCase())) return alert('Já existe uma conta com esse nome.');
      const conta=n.contas.find(c=> c.nome===oldName);
      conta.nome=newName;
      // reclassificar lançamentos
      state.lanc.forEach(l=>{ if(l.natureza===n.code && l.conta===oldName){ l.conta=newName; } });
      document.getElementById('pcRenomearConta').value='';
      persist(); renderPlanoContas(); fillContas(); fillPcContas(); alert('Conta renomeada e lançamentos reclassificados.');
    });
    document.getElementById('pcBtnExcluir').addEventListener('click', ()=>{
      const n=state.tax.find(x=> x.code===pcNat.value);
      const name=pcConta.value;
      if(!name) return alert('Selecione uma conta');
      uiDeleteConta(n.code, name);
    });
    // Ações inline na árvore
    window.uiRenameConta = (natCode, name)=>{
      pcNat.value = natCode;
      fillPcContas();
      pcConta.value = name;
      document.getElementById('pcRenomearConta').focus();
    }
    window.uiDeleteConta = (natCode, name)=>{
      const n=state.tax.find(x=> x.code===natCode);
      const depend = state.lanc.filter(l=> l.natureza===natCode && l.conta===name).length;
      let destino = null;
      if(depend>0){
        const outros = n.contas.map(c=>c.nome).filter(x=> x!==name);
        if(outros.length===0){ alert('Não é possível excluir: existe(m) lançamento(s) nessa conta e não há outra conta para reclassificar. Crie uma nova conta e tente novamente.'); return; }
        destino = prompt(`Encontrados ${depend} lançamento(s) em "${name}". Digite o nome da conta de destino dentre:\n- ${outros.join('\n- ')}`);
        if(!destino || !outros.includes(destino)){ alert('Operação cancelada.'); return; }
      }
      if(!confirm(`Excluir a conta "${name}" da Natureza ${n.nome}?`)) return;
      // Reclassificar se necessário
      if(destino){ state.lanc.forEach(l=>{ if(l.natureza===natCode && l.conta===name){ l.conta = destino; } }); }
      // Mesclar categorias na conta destino (se houver)
      if(destino){ const contaDst = n.contas.find(c=> c.nome===destino); const contaSrc = n.contas.find(c=> c.nome===name); contaSrc.cats.forEach(cat=>{ if(!contaDst.cats.includes(cat)) contaDst.cats.push(cat); }); }
      // Remover conta
      n.contas = n.contas.filter(c=> c.nome!==name);
      persist(); renderPlanoContas(); fillContas(); fillPcContas(); alert('Conta excluída com sucesso.');
    }

    // ===== Config: Centros =====
    const tabCentrosBody = ()=> document.querySelector('#tabCentros tbody');
    function renderCentros(){
      const tbody=tabCentrosBody();
      tbody.innerHTML='';
      state.centros.forEach((c,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${c.nome}</td><td><input type="number" min="0" step="0.01" value="${c.area}" onchange="updArea(${idx}, this.value)"/></td><td style="text-align:right">${c.nome!=='Geral'?`<button class='danger' onclick='delCentro(${idx})'>Remover</button>`:''}</td>`;
        tbody.appendChild(tr);
      });
    }
    window.updArea = (idx,val)=>{
      state.centros[idx].area = Number(val)||0;
      persist();
    }
    window.delCentro = (idx)=>{
      if(!confirm('Remover este centro?')) return;
      const nome=state.centros[idx].nome;
      if(nome==='Geral') return alert('Não é permitido remover "Geral".');
      state.centros.splice(idx,1);
      persist(); renderCentros(); fillCentros();
    }
    document.getElementById('addCentro').addEventListener('click', ()=>{
      const nome=document.getElementById('novoCentro').value.trim();
      const area=Number(document.getElementById('novoCentroArea').value)||0;
      if(!nome) return alert('Informe o nome do centro');
      if(state.centros.some(c=>c.nome.toLowerCase()===nome.toLowerCase())) return alert('Centro já existe.');
      state.centros.push({nome, area});
      document.getElementById('novoCentro').value='';
      document.getElementById('novoCentroArea').value='';
      persist(); renderCentros(); fillCentros();
    });
    document.getElementById('apagarTudo').addEventListener('click', ()=>{
      if(!confirm('Excluir TODOS os dados de teste?')) return;
      state.lanc=[];
      state.centros=[];
      state.areaTotal=0;
      state.tax=null;
      persist(); location.reload();
    });

    // ===== Demonstrativos: Safra/Ano com filtro de centro e IR =====
    // Preenche seletor de centro para demonstrativo
    function fillDemoCentro(){
      const sel=document.getElementById('demoCentro');
      if(!sel) return;
      sel.innerHTML='';
      const optAll=document.createElement('option');
      optAll.value='Todos';
      optAll.textContent='Todos';
      sel.appendChild(optAll);
      state.centros.forEach(c=>{
        const o=document.createElement('option');
        o.value=c.nome;
        o.textContent=c.nome;
        sel.appendChild(o);
      });
    }
    // Função que define período corrente a partir das opções Safra/Ano e ano base
    function currentPeriod(){
      const y = Number(document.getElementById('demoSafra').value || new Date().getFullYear());
      const tipo = document.getElementById('demoTipo').value;
      if(tipo === 'safra'){
        return { start:`${y}-08-01`, end:`${y+1}-07-31`, irOnly:false };
      } else {
        return { start:`${y}-01-01`, end:`${y}-12-31`, irOnly: !!document.getElementById('demoIrOnly').checked };
      }
    }
    // Atualiza labels conforme tipo de demonstrativo
    function onTipoChange(){
      const tipo=document.getElementById('demoTipo').value;
      const lblPeriodo=document.getElementById('lblPeriodo');
      const helpPeriodo=document.getElementById('helpPeriodo');
      const wrapIr=document.getElementById('wrapIr');
      if(tipo==='safra'){
        lblPeriodo.textContent='Safra (agosto a julho)';
        helpPeriodo.textContent='Ex.: 2024 — considera 01/08/2024 a 31/07/2025';
        wrapIr.style.display='none';
      } else {
        lblPeriodo.textContent='Ano (janeiro a dezembro)';
        helpPeriodo.textContent='Ex.: 2024 — considera 01/01/2024 a 31/12/2024';
        wrapIr.style.display='inline-flex';
      }
      renderDemo();
    }
    // Define ano base padrão para safra/ano (safra corrente)
    function setupDemoDefaults(){
      const now=new Date();
      // se estivermos depois de julho (mês 7), safra inicia no ano atual; caso contrário, ano anterior
      const safraYear = (now.getMonth()>=7) ? now.getFullYear() : now.getFullYear()-1;
      document.getElementById('demoTipo').value='safra';
      document.getElementById('demoSafra').value=String(safraYear);
      document.getElementById('wrapIr').style.display='none';
    }
    // Renderiza a tabela de demonstrativo com colunas mensais e total
    function renderDemo(){
      const tbody=document.querySelector('#tabDemo tbody');
      const thead=document.getElementById('demoHeader');
      tbody.innerHTML='';
      thead.innerHTML='';
      const {start,end,irOnly} = currentPeriod();
      // monta array de meses entre start e end
      const months=[];
      let d=new Date(start + 'T00:00:00'); d.setDate(1);
      const endDate=new Date(end + 'T00:00:00'); endDate.setDate(1);
      while(d<=endDate){ months.push(new Date(d)); d.setMonth(d.getMonth()+1); }
      // monta cabeçalho
      const monthNames=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
      let headerHtml='<th>Centro</th>';
      months.forEach(m => {
        headerHtml += `<th>${monthNames[m.getMonth()]}/${String(m.getFullYear()).slice(-2)}</th>`;
      });
      headerHtml += '<th>Total</th>';
      thead.innerHTML=headerHtml;
      // filtra lançamentos do período
      let arr=state.lanc.filter(x=> x.data && x.data>=start && x.data<=end);
      if(irOnly){ arr=arr.filter(x=> x.ir===true); }
      // centros a exibir
      const centroSel=document.getElementById('demoCentro').value || 'Todos';
      const centres=(centroSel==='Todos') ? state.centros.map(c=> c.nome) : [centroSel];
      centres.forEach(nomeCentro => {
        let totalNet=0;
        let rowHtml='<td>'+nomeCentro+'</td>';
        months.forEach(md => {
          const ym=md.toISOString().slice(0,7);
          let rec=0, desp=0;
          arr.forEach(x => {
            const cName=x.centro || 'Geral';
            if(cName===nomeCentro && x.data.startsWith(ym)){
              if(x.natureza==='RO' || x.natureza==='RNO') rec += x.valor; else desp += x.valor;
            }
          });
          const net=rec-desp;
          totalNet += net;
          rowHtml += `<td>${BRL.format(net)}</td>`;
        });
        rowHtml += `<td style="font-weight:700">${BRL.format(totalNet)}</td>`;
        tbody.innerHTML += `<tr>${rowHtml}</tr>`;
      });
    }
    // Eventos do demonstrativo
    document.getElementById('demoTipo').addEventListener('change', onTipoChange);
    document.getElementById('demoSafra').addEventListener('input', renderDemo);
    document.getElementById('demoIrOnly').addEventListener('change', renderDemo);
    document.getElementById('demoCentro').addEventListener('change', renderDemo);
    document.getElementById('areaTotal').addEventListener('input', (e)=>{
      state.areaTotal = Number(e.target.value)||0;
      persist(); renderDemo();
    });

    // ===== Exportar / Importar CSV =====
    document.getElementById('exportCsv').addEventListener('click', ()=>{
      const header=['id','data','natureza','conta','categoria','descricao','centro','pagamento','ir','valor'];
      const rows=state.lanc.map(x=> header.map(h=>{
        const v=x[h]??'';
        return typeof v==='number'? String(v).replace('.',',') : String(v).replace(/"/g,'""');
      }));
      const csv=[header.join(';')].concat(rows.map(r=> r.join(';'))).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='sinuelo_finance.csv';
      a.click();
    });
    document.getElementById('importCsvBtn').addEventListener('click', ()=> document.getElementById('importCsv').click());
    document.getElementById('importCsv').addEventListener('change', (e)=>{
      const file=e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{
        const lines=reader.result.split(/\r?\n/).filter(Boolean);
        const header=lines.shift().split(';');
        const idx=(name)=> header.indexOf(name);
        const arr=lines.map(l=>{
          const c=l.split(';');
          return {
            id:c[idx('id')]||crypto.randomUUID(),
            data:c[idx('data')],
            natureza:c[idx('natureza')]||c[idx('tipo')],
            conta:c[idx('conta')],
            categoria:c[idx('categoria')],
            descricao:c[idx('descricao')],
            centro:c[idx('centro')],
            pagamento:c[idx('pagamento')],
            ir: ((c[idx('ir')]||'').toLowerCase()=='true' || c[idx('ir')]=='1'),
            valor: parseBR(c[idx('valor')]||'0')
          };
        });
        state.lanc=arr.concat(state.lanc);
        persist(); updateKPIs();
        alert('Importado! Abra o Extrato/Demonstrativos para conferir.');
      };
      reader.readAsText(file,'utf-8');
    });

    // ===== Inicialização =====
    document.getElementById('ano').textContent = new Date().getFullYear();
    document.getElementById('data').value = new Date().toISOString().slice(0,10);
    // Preenche filtros
    const filtroNaturezaSel = document.getElementById('filtroNatureza');
    filtroNaturezaSel.innerHTML = '<option value="">Todas</option>';
    state.tax.forEach(n=>{
      const o=document.createElement('option');
      o.value=n.code;
      o.textContent=`${n.code} — ${n.nome}`;
      filtroNaturezaSel.appendChild(o);
    });
    // Preenche seletores iniciais e KPIs
    fillNatureza(); fillContas(); fillCentros(); fillDemoCentro();
    setupDemoDefaults();
    updateKPIs();
    renderPlanoContas();
    renderCentros();
  </script>
</body>
</html>