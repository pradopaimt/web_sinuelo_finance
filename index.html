<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/favicon.ico" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <title>Sinuelo Finance — Protótipo v0.3 (PWA + Centros de Custo)</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent-2:#06b6d4; --danger:#ef4444; --warn:#f59e0b; --ok:#10b981;
      --shadow: 0 10px 25px rgba(0,0,0,.35); --radius: 16px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Noto Sans,Arial; color:var(--text); background:linear-gradient(180deg,#0b1220 0%,#0f172a 100%); min-height:100svh}
    header{position:sticky; top:0; z-index:10; background:rgba(15,23,42,.8); backdrop-filter:saturate(1.2) blur(10px); border-bottom:1px solid rgba(255,255,255,.06)}
    .container{max-width:1100px; margin:0 auto; padding:16px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:36px; height:36px; border-radius:12px; background:radial-gradient(circle at 30% 30%, var(--accent) 0%, #16a34a 35%, #164e63 100%); box-shadow:var(--shadow)}
    h1{font-size:20px; margin:0; letter-spacing:.3px}
    nav{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; align-items:center}
    .tab{border:1px solid rgba(255,255,255,.08); background:#0b1220; color:var(--text); padding:10px 14px; border-radius:999px; cursor:pointer; user-select:none}
    .tab.active{background:var(--accent-2); color:#001015; border-color:transparent; font-weight:600}
    .install{margin-left:auto; display:flex; gap:8px; align-items:center}
    .install button{background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.18)}
    .grid{display:grid; gap:16px; grid-template-columns:1fr}
    @media (min-width: 900px){ .grid{grid-template-columns: 1.1fr .9fr} }
    .card{background:rgba(17,24,39,.75); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)}
    .card h2{margin:4px 0 12px 0; font-size:18px}
    label{font-size:12px; color:var(--muted)}
    input, select, textarea{width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0b1220; color:var(--text)}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:700px){.row.cols-2{grid-template-columns:1fr 1fr}}
    @media(min-width:900px){.row.cols-3{grid-template-columns:1fr 1fr 1fr}}
    button{appearance:none; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; background:var(--accent); color:#052e16; font-weight:700; box-shadow:var(--shadow)}
    button.secondary{background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.1)}
    button.danger{background:var(--danger); color:#310808}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
    .kpi{background:#0b1220;border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:20px; font-weight:800; margin-top:4px}
    table{width:100%; border-collapse:collapse}
    th, td{ padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left; font-size:14px}
    th{color:var(--muted); font-weight:600}
    tr:hover{background:rgba(255,255,255,.03)}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700}
    .pill.in{background:rgba(34,197,94,.15); color:#86efac; border:1px solid rgba(34,197,94,.35)}
    .pill.out{background:rgba(239,68,68,.12); color:#fecaca; border:1px solid rgba(239,68,68,.35)}
    footer{color:var(--muted); font-size:12px; text-align:center; padding:24px}
    @media (display-mode: standalone){ body{background:#0f172a} }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Agropecuária Sinuelo — Finance</h1>
          <div style="font-size:12px; color:var(--muted)">Protótipo PWA-ready (v0.3) • Centros de Custo com rateio</div>
        </div>
      </div>
      <nav style="margin-top:14px">
        <div class="tab active" data-tab="lancamentos">Lançamentos</div>
        <div class="tab" data-tab="extrato">Extrato</div>
        <div class="tab" data-tab="categorias">Categorias</div>
        <div class="tab" data-tab="demo">Demonstrativos</div>
        <div class="tab" data-tab="config">Configurações</div>
        <div class="install">
          <button id="btnInstall" style="display:none">Instalar app</button>
          <span id="installHint" style="font-size:12px; color:var(--muted); display:none">Use ⋮ → Adicionar à tela inicial</span>
        </div>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-top:18px">
    <section id="lancamentos" class="grid">
      <div class="card">
        <h2>Novo lançamento</h2>
        <form id="formLanc" autocomplete="off">
          <div class="row cols-3">
            <div>
              <label for="data">Data</label>
              <input type="date" id="data" required />
            </div>
            <div>
              <label for="tipo">Natureza</label>
              <select id="tipo" required>
                <option value="RO">Receita Operacional</option>
                <option value="RNO">Receita Não Operacional</option>
                <option value="DO">Despesa Operacional</option>
                <option value="DNO">Despesa Não Operacional</option>
              </select>
            </div>
            <div>
              <label for="valor">Valor (R$)</label>
              <input inputmode="decimal" id="valor" placeholder="0,00" required />
            </div>
          </div>

          <div class="row cols-2" style="margin-top:12px">
            <div>
              <label for="categoria">Categoria</label>
              <select id="categoria"></select>
            </div>
            <div>
              <label for="centro">Centro de Custo</label>
              <select id="centro"></select>
            </div>
          </div>

          <div class="row cols-2" style="margin-top:12px">
            <div>
              <label for="descricao">Descrição</label>
              <input id="descricao" placeholder="Ex.: Venda bezerros, ração, adubo..." />
            </div>
            <div>
              <label for="pagamento">Forma de pagamento</label>
              <select id="pagamento">
                <option>Pix</option>
                <option>Dinheiro</option>
                <option>Cartão</option>
                <option>Boleto</option>
                <option>Transferência</option>
                <option>Nota a pagar/receber</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <label for="anexo">Anexo (foto ou PDF da nota)</label>
              <input type="file" id="anexo" accept="image/*,.pdf" />
            </div>
          </div>

          <div class="btns" style="margin-top:16px">
            <button type="submit">Salvar lançamento</button>
            <button type="button" class="secondary" id="limpar">Limpar</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>Resumo rápido (mês)</h2>
        <div class="kpis">
          <div class="kpi"><div class="label">Receita Operacional</div><div class="value" id="kpiRO">R$ 0,00</div></div>
          <div class="kpi"><div class="label">Receita Não Operac.</div><div class="value" id="kpiRNO">R$ 0,00</div></div>
          <div class="kpi"><div class="label">Despesa Operacional</div><div class="value" id="kpiDO">R$ 0,00</div></div>
          <div class="kpi"><div class="label">Despesa Não Operac.</div><div class="value" id="kpiDNO">R$ 0,00</div></div>
        </div>
        <div style="margin-top:8px; font-size:13px; color:var(--muted)">Saldo: <b id="kpiSaldo">R$ 0,00</b></div>
        <div style="margin-top:16px" class="btns">
          <button type="button" class="secondary" id="exportCsv">Exportar CSV</button>
          <button type="button" class="secondary" id="importCsvBtn">Importar CSV</button>
          <input type="file" id="importCsv" accept="text/csv" style="display:none" />
        </div>
      </div>
    </section>

    <section id="extrato" class="card" style="display:none">
      <div class="row cols-3">
        <div>
          <label for="filtroMes">Mês</label>
          <input type="month" id="filtroMes" />
        </div>
        <div>
          <label for="filtroTipo">Natureza</label>
          <select id="filtroTipo">
            <option value="">Todas</option>
            <option value="RO">Receita Operacional</option>
            <option value="RNO">Receita Não Operacional</option>
            <option value="DO">Despesa Operacional</option>
            <option value="DNO">Despesa Não Operacional</option>
          </select>
        </div>
        <div>
          <label for="buscaTxt">Busca</label>
          <input id="buscaTxt" placeholder="Descrição, categoria, centro..." />
        </div>
      </div>
      <div style="overflow:auto; margin-top:12px">
        <table id="tabela">
          <thead>
            <tr>
              <th>Data</th>
              <th>Natureza</th>
              <th>Categoria</th>
              <th>Descrição</th>
              <th>Centro</th>
              <th>Pagamento</th>
              <th>Valor</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="categorias" class="card" style="display:none">
      <h2>Gerenciar categorias</h2>
      <div class="row cols-3">
        <div>
          <label>Nova categoria</label>
          <input id="novaCat" placeholder="Ex.: Ração, Adubo, Venda gado..." />
        </div>
        <div>
          <label>Natureza</label>
          <select id="grupoCat">
            <option value="RO">Receita Operacional</option>
            <option value="RNO">Receita Não Operacional</option>
            <option value="DO">Despesa Operacional</option>
            <option value="DNO">Despesa Não Operacional</option>
          </select>
        </div>
        <div class="btns" style="align-items:end">
          <button id="addCat">Adicionar</button>
        </div>
      </div>
      <div style="margin-top:12px; overflow:auto">
        <table id="tabCats">
          <thead><tr><th>Categoria</th><th>Natureza</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="demo" class="card" style="display:none">
      <h2>Demonstrativos por Centro de Custo (com rateio do "Geral")</h2>
      <div class="row cols-3">
        <div>
          <label>Mês</label>
          <input type="month" id="demoMes" />
        </div>
        <div>
          <label>Área Total da Fazenda (ha)</label>
          <input type="number" id="areaTotal" min="0" step="0.01" />
        </div>
      </div>
      <div style="overflow:auto; margin-top:12px">
        <table id="tabDemo">
          <thead><tr><th>Centro</th><th>Área (ha)</th><th>Receitas</th><th>Despesas</th><th>Saldo</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <p style="color:var(--muted); font-size:13px; margin-top:8px">As receitas/despesas lançadas em <b>Geral</b> são rateadas proporcionalmente à área de cada centro (exclui-se "Geral" do rateio).</p>
    </section>

    <section id="config" class="card" style="display:none">
      <h2>Configurações</h2>
      <div class="row cols-2">
        <div>
          <h3 style="margin:0 0 8px 0; font-size:16px">Centros de Custo</h3>
          <div class="row cols-3">
            <div>
              <label>Novo centro</label>
              <input id="novoCentro" placeholder="Ex.: Agricultura de Precisão" />
            </div>
            <div>
              <label>Área (ha)</label>
              <input id="novoCentroArea" type="number" min="0" step="0.01" />
            </div>
            <div class="btns" style="align-items:end"><button id="addCentro">Adicionar</button></div>
          </div>
          <div style="overflow:auto; margin-top:12px">
            <table id="tabCentros">
              <thead><tr><th>Centro</th><th>Área (ha)</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <p style="color:var(--muted); font-size:14px; line-height:1.5">
            Este protótipo salva os dados apenas no <strong>navegador (localStorage)</strong> para testes.
            Na versão real, haverá login, banco seguro e OCR de notas. Os centros iniciais são <b>Geral</b>, <b>Soja</b>, <b>Bovinos</b> e <b>Ovinos</b>.
          </p>
          <div class="btns"><button class="danger" id="apagarTudo">Apagar todos os dados (teste)</button></div>
        </div>
      </div>
    </section>
  </main>

  <footer>© <span id="ano"></span> Agropecuária Sinuelo • Protótipo</footer>

  <script>
    // ===== PWA =====
    if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(console.warn)); }
    let deferredPrompt; const btnInstall=document.getElementById('btnInstall'); const installHint=document.getElementById('installHint');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; btnInstall.style.display='inline-flex'; installHint.style.display='none'; });
    btnInstall?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; btnInstall.style.display='none'; });
    window.addEventListener('appinstalled', ()=> btnInstall.style.display='none'); setTimeout(()=>{ if(btnInstall && btnInstall.style.display==='none'){ installHint.style.display='inline'; } }, 2500);

    // ===== Utils =====
    const BRL = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });
    const parseBR = (s)=> Number(String(s).replace(/\./g,'').replace(',','.')) || 0;
    const fmtDate = (iso)=> new Date(iso + 'T00:00:00').toLocaleDateString('pt-BR');

    // ===== Estado =====
    const state = {
      lanc: JSON.parse(localStorage.getItem('sinuelo_lanc')||'[]'),
      cats: JSON.parse(localStorage.getItem('sinuelo_cats')||'[]'),
      centros: JSON.parse(localStorage.getItem('sinuelo_centros')||'[]'),
      areaTotal: Number(localStorage.getItem('sinuelo_area_total')||'0')
    };

    // Migração: centros antigos (array de strings) -> objetos {nome, area}
    if(state.centros.length && typeof state.centros[0] === 'string'){
      state.centros = state.centros.map(n=> ({nome:n, area:0})); persist();
    }

    // Defaults iniciais
    if(state.cats.length === 0){
      state.cats = [
        {nome:'Venda de gado', grupo:'RO'}, {nome:'Venda de grãos', grupo:'RO'},
        {nome:'Ração', grupo:'DO'}, {nome:'Sal mineral', grupo:'DO'}, {nome:'Adubo', grupo:'DO'}, {nome:'Mão-de-obra', grupo:'DO'},
        {nome:'Juros', grupo:'DNO'}, {nome:'Venda de ativo', grupo:'RNO'}
      ];
    }
    if(state.centros.length === 0){
      state.centros = [ {nome:'Geral', area:0}, {nome:'Soja', area:0}, {nome:'Bovinos', area:0}, {nome:'Ovinos', area:0} ];
    }
    persist();

    // ===== Tabs =====
    const tabs = document.querySelectorAll('.tab');
    const sections = ['lancamentos','extrato','categorias','demo','config'];
    tabs.forEach(t=> t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      sections.forEach(id => document.getElementById(id).style.display = id===t.dataset.tab ? (id==='lancamentos'?'grid':'block') : 'none');
      if(t.dataset.tab==='extrato') renderTabela();
      if(t.dataset.tab==='categorias') renderCats();
      if(t.dataset.tab==='lancamentos') updateKPIs();
      if(t.dataset.tab==='config') { renderCentros(); }
      if(t.dataset.tab==='demo') { document.getElementById('areaTotal').value = state.areaTotal || 0; renderDemo(); }
    }));

    // ===== Form Lançamento =====
    const el = {
      data: document.getElementById('data'), tipo: document.getElementById('tipo'), valor: document.getElementById('valor'),
      categoria: document.getElementById('categoria'), centro: document.getElementById('centro'), pagamento: document.getElementById('pagamento'), descricao: document.getElementById('descricao'), anexo: document.getElementById('anexo')
    };

    el.valor.addEventListener('input', (e)=>{ const raw=e.target.value.replace(/[^\d]/g,''); const num=(Number(raw)/100).toFixed(2); e.target.value = num.replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g, '.'); });

    function fillCategoria(){ const sel=el.categoria; sel.innerHTML=''; const grupo=el.tipo.value; state.cats.filter(c=>c.grupo===grupo).forEach(c=>{ const o=document.createElement('option'); o.textContent=c.nome; o.value=c.nome; sel.appendChild(o); }); }
    el.tipo.addEventListener('change', fillCategoria);

    function fillCentros(){ const sel=el.centro; sel.innerHTML=''; state.centros.forEach(c=>{ const o=document.createElement('option'); o.value=c.nome; o.textContent=c.nome; sel.appendChild(o); }); }

    function persist(){ localStorage.setItem('sinuelo_lanc', JSON.stringify(state.lanc)); localStorage.setItem('sinuelo_cats', JSON.stringify(state.cats)); localStorage.setItem('sinuelo_centros', JSON.stringify(state.centros)); localStorage.setItem('sinuelo_area_total', String(state.areaTotal||0)); }

    document.getElementById('formLanc').addEventListener('submit', (e)=>{
      e.preventDefault();
      const item = { id: crypto.randomUUID(), data: el.data.value || new Date().toISOString().slice(0,10), tipo: el.tipo.value, valor: parseBR(el.valor.value), categoria: el.categoria.value || '', centro: el.centro.value || 'Geral', pagamento: el.pagamento.value || '', descricao: el.descricao.value || '', anexoNome: el.anexo.files[0]?.name || null };
      state.lanc.unshift(item); persist(); (document.getElementById('formLanc')).reset(); fillCategoria(); fillCentros(); updateKPIs(); alert('Lançamento salvo!');
    });

    document.getElementById('limpar').addEventListener('click', ()=>{ (document.getElementById('formLanc')).reset(); fillCategoria(); });

    // ===== KPIs (mês atual) =====
    function updateKPIs(){ const now=new Date(); const ym=now.toISOString().slice(0,7); const mes=state.lanc.filter(x=> x.data?.startsWith(ym)); const sum=(arr,cond)=> arr.filter(cond).reduce((s,x)=>s+x.valor,0);
      const ro=sum(mes,x=>x.tipo==='RO'), rno=sum(mes,x=>x.tipo==='RNO'), doo=sum(mes,x=>x.tipo==='DO'), dno=sum(mes,x=>x.tipo==='DNO');
      document.getElementById('kpiRO').textContent=BRL.format(ro); document.getElementById('kpiRNO').textContent=BRL.format(rno); document.getElementById('kpiDO').textContent=BRL.format(doo); document.getElementById('kpiDNO').textContent=BRL.format(dno); document.getElementById('kpiSaldo').textContent=BRL.format(ro+rno-doo-dno); }

    // ===== Extrato =====
    const filtroMes=document.getElementById('filtroMes'); const filtroTipo=document.getElementById('filtroTipo'); const buscaTxt=document.getElementById('buscaTxt'); [filtroMes,filtroTipo,buscaTxt].forEach(x=> x.addEventListener('input', renderTabela));
    function renderTabela(){ const tbody=document.querySelector('#tabela tbody'); tbody.innerHTML=''; let arr=[...state.lanc]; if(filtroMes.value) arr=arr.filter(x=> x.data?.startsWith(filtroMes.value)); if(filtroTipo.value) arr=arr.filter(x=> x.tipo===filtroTipo.value); const q=buscaTxt.value?.toLowerCase?.()||''; if(q) arr=arr.filter(x=> (x.categoria+x.descricao+x.centro+x.pagamento).toLowerCase().includes(q)); arr.forEach(x=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${fmtDate(x.data)}</td><td>${x.tipo}</td><td>${x.categoria||'-'}</td><td>${x.descricao||'-'}</td><td>${x.centro||'-'}</td><td>${x.pagamento||'-'}</td><td style="font-weight:700">${BRL.format(x.valor)}</td><td style="text-align:right"><button class="secondary" onclick="editar('${x.id}')">Editar</button> <button class="danger" onclick="excluir('${x.id}')">Excluir</button></td>`; tbody.appendChild(tr); }); }

    window.editar = (id)=>{ const x=state.lanc.find(i=>i.id===id); if(!x) return; document.querySelector('[data-tab="lancamentos"]').click(); el.data.value=x.data; el.tipo.value=x.tipo; fillCategoria(); el.categoria.value=x.categoria; el.valor.value=BRL.format(x.valor).replace('R$\xa0','').trim(); fillCentros(); el.centro.value=x.centro; el.pagamento.value=x.pagamento; el.descricao.value=x.descricao; state.lanc=state.lanc.filter(i=>i.id!==id); persist(); updateKPIs(); }
    window.excluir = (id)=>{ if(!confirm('Excluir este lançamento?')) return; state.lanc=state.lanc.filter(i=>i.id!==id); persist(); renderTabela(); updateKPIs(); }

    // ===== Categorias =====
    function renderCats(){ const tbody=document.querySelector('#tabCats tbody'); tbody.innerHTML=''; state.cats.forEach((c,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.nome}</td><td>${c.grupo}</td><td style="text-align:right"><button class="danger" onclick="delCat(${idx})">Remover</button></td>`; tbody.appendChild(tr); }); }
    window.delCat = (idx)=>{ state.cats.splice(idx,1); persist(); renderCats(); fillCategoria(); }
    document.getElementById('addCat').addEventListener('click', ()=>{ const nome=document.getElementById('novaCat').value.trim(); const grupo=document.getElementById('grupoCat').value; if(!nome) return alert('Informe o nome da categoria'); state.cats.push({nome,grupo}); persist(); document.getElementById('novaCat').value=''; renderCats(); fillCategoria(); });

    // ===== Config: Centros de Custo =====
    const tabCentrosBody = ()=> document.querySelector('#tabCentros tbody');
    function renderCentros(){ const tbody=tabCentrosBody(); tbody.innerHTML=''; state.centros.forEach((c,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.nome}</td><td><input type="number" min="0" step="0.01" value="${c.area}" onchange="updArea(${idx}, this.value)"/></td><td style="text-align:right">${c.nome!=='Geral'?`<button class='danger' onclick='delCentro(${idx})'>Remover</button>`:''}</td>`; tbody.appendChild(tr); }); }
    window.updArea = (idx,val)=>{ state.centros[idx].area = Number(val)||0; persist(); }
    window.delCentro = (idx)=>{ if(!confirm('Remover este centro?')) return; const nome=state.centros[idx].nome; if(nome==='Geral') return alert('Não é permitido remover "Geral".'); state.centros.splice(idx,1); persist(); renderCentros(); fillCentros(); }
    document.getElementById('addCentro').addEventListener('click', ()=>{ const nome=document.getElementById('novoCentro').value.trim(); const area=Number(document.getElementById('novoCentroArea').value)||0; if(!nome) return alert('Informe o nome do centro'); if(state.centros.some(c=>c.nome.toLowerCase()===nome.toLowerCase())) return alert('Centro já existe.'); state.centros.push({nome, area}); document.getElementById('novoCentro').value=''; document.getElementById('novoCentroArea').value=''; persist(); renderCentros(); fillCentros(); });

    document.getElementById('apagarTudo').addEventListener('click', ()=>{ if(!confirm('Excluir TODOS os dados de teste?')) return; state.lanc=[]; state.cats=[]; state.centros=[]; state.areaTotal=0; persist(); location.reload(); });

    // ===== Demo: rateio do "Geral" por área =====
    const demoMes=document.getElementById('demoMes'); demoMes.addEventListener('input', renderDemo);
    document.getElementById('areaTotal').addEventListener('input', (e)=>{ state.areaTotal = Number(e.target.value)||0; persist(); renderDemo(); });

    function renderDemo(){ const tbody=document.querySelector('#tabDemo tbody'); tbody.innerHTML=''; const ym = demoMes.value || new Date().toISOString().slice(0,7); const arr = state.lanc.filter(x=> x.data?.startsWith(ym));
      const centers = state.centros.map(c=> ({...c}));
      const sumBy=(f)=> arr.reduce((acc,x)=>{ const k=f(x); acc[k]=(acc[k]||0)+ (x.tipo==='RO'||x.tipo==='RNO'? x.valor : -x.valor); return acc; }, {});
      // Totais por centro sem rateio
      const totals = arr.reduce((acc,x)=>{ const c=x.centro||'Geral'; if(!acc[c]) acc[c]={rec:0,desp:0}; if(x.tipo==='RO'||x.tipo==='RNO') acc[c].rec += x.valor; else acc[c].desp += x.valor; return acc; },{});
      const geral = totals['Geral'] || {rec:0, desp:0};
      // Base para rateio: centros exceto Geral com área > 0
      const base = centers.filter(c=> c.nome!=='Geral' && c.area>0);
      const somaArea = base.reduce((s,c)=> s+c.area,0) || 0;
      // Monta linhas com rateio
      centers.forEach(c=>{
        const own = totals[c.nome] || {rec:0, desp:0};
        let rec = own.rec, desp = own.desp;
        if(c.nome!=='Geral' && somaArea>0){ const share = c.area / somaArea; rec += geral.rec * share; desp += geral.desp * share; }
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.nome}</td><td>${(c.area||0).toLocaleString('pt-BR')}</td><td>${BRL.format(rec)}</td><td>${BRL.format(desp)}</td><td style='font-weight:700'>${BRL.format(rec-desp)}</td>`; tbody.appendChild(tr);
      });
    }

    // ===== Exportar / Importar CSV =====
    document.getElementById('exportCsv').addEventListener('click', ()=>{ const header=['id','data','tipo','categoria','descricao','centro','pagamento','valor']; const rows=state.lanc.map(x=> header.map(h=>{ const v=x[h]??''; return typeof v==='number'? String(v).replace('.',',') : String(v).replace(/\"/g,'""'); })); const csv=[header.join(';')].concat(rows.map(r=> r.join(';'))).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sinuelo_finance.csv'; a.click(); });
    document.getElementById('importCsvBtn').addEventListener('click', ()=> document.getElementById('importCsv').click());
    document.getElementById('importCsv').addEventListener('change', (e)=>{ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{ const lines=reader.result.split(/\r?\n/).filter(Boolean); const header=lines.shift().split(';'); const idx=(name)=> header.indexOf(name); const arr=lines.map(l=>{ const c=l.split(';'); return { id:c[idx('id')]||crypto.randomUUID(), data:c[idx('data')], tipo:c[idx('tipo')], categoria:c[idx('categoria')], descricao:c[idx('descricao')], centro:c[idx('centro')], pagamento:c[idx('pagamento')], valor:parseBR(c[idx('valor')]||'0') }; }); state.lanc=arr.concat(state.lanc); persist(); updateKPIs(); alert('Importado! Abra o Extrato/Demonstrativos para conferir.'); }; reader.readAsText(file,'utf-8'); });

    // ===== Inicialização =====
    document.getElementById('ano').textContent = new Date().getFullYear();
    document.getElementById('data').value = new Date().toISOString().slice(0,10);
    document.getElementById('demoMes').value = new Date().toISOString().slice(0,7);
    fillCategoria(); fillCentros(); updateKPIs(); renderCentros();
  </script>

  <!-- =====================
    ARQUIVOS EXTERNOS PWA (crie estes arquivos na raiz do projeto)
    1) manifest.webmanifest
    2) sw.js
    3) icons/ (icon-192.png, icon-512.png, maskable-512.png, favicon.ico)
    ===================== -->

  <!-- manifest.webmanifest (exemplo) ... ver mensagem anterior -->
  <!-- sw.js (exemplo) ... ver mensagem anterior -->
</body>
</html>
